<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout – Custom Phone Cases</title>
  <script src="https://js.stripe.com/v3/"></script>
  <script src="config/constants.js"></script>
  <style>
    body{font-family:Arial,sans-serif;background:#f9f9f9;margin:0;padding:0;}
    .container{max-width:560px;margin:20px auto;background:#fff;padding:24px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.08);}
    h1{font-size:1.6rem;margin-bottom:16px;text-align:center;}
    .section{margin-bottom:24px;}
    label{display:block;margin-bottom:6px;font-weight:600;}
    input,select{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:1rem;}
    .checkbox-line{display:flex;align-items:center;margin-top:12px;}
    .checkbox-line input{width:auto;margin-right:8px;}
    .gift-hint{color:#d4af37;font-weight:600;margin-top:4px;}
    .summary{border-top:1px solid #eee;padding-top:12px;}
    .summary line{display:flex;justify-content:space-between;margin:6px 0;font-size:14px;}
    .total{font-weight:bold;font-size:1.2rem;color:#2c5530;}
    button{background:#007bff;color:#fff;border:none;padding:14px;border-radius:8px;font-size:1rem;cursor:pointer;width:100%;margin-top:20px;}
    button:disabled{background:#aaa;cursor:not-allowed;}
    .error{color:#dc3545;margin-top:8px;}
    .hidden{display:none;}
  </style>
</head>
<body>
<div class="container">
  <h1>Checkout</h1>

  <!-- Cart summary (read-only) -->
  <div class="section" id="cart-summary"></div>

  <!-- Gift option (mirrors cart modal) -->
  <div class="section">
    <div class="checkbox-line">
      <input type="checkbox" id="gift-checkbox">
      <label for="gift-checkbox">Send as a gift (+ $12.00)</label>
    </div>
    <div class="gift-hint hidden" id="gift-hint">We'll wrap it and ship directly to the recipient</div>
  </div>

  <!-- Shipping address -->
  <div class="section">
    <h2 id="shipping-title">Shipping Address</h2>
    <label>Full Name</label><input type="text" id="ship-name" required>
    <label>Street Address</label><input type="text" id="ship-street" required>
    <label>Apartment, suite, etc. (optional)</label><input type="text" id="ship-apt">
    <label>City</label><input type="text" id="ship-city" required>
    <label>State / Province</label>
    <select id="ship-state" required>
      <option value="">-- Select --</option>
      <!-- US states only (dummy list) -->
      <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option>
      <option value="AR">Arkansas</option><option value="CA">California</option><option value="CO">Colorado</option>
      <!-- …add the rest as needed… -->
      <option value="WY">Wyoming</option>
    </select>
    <label>ZIP Code</label><input type="text" id="ship-zip" pattern="\d{5}" required>
  </div>

  <!-- Billing address (same by default) -->
  <div class="section">
    <div class="checkbox-line">
      <input type="checkbox" id="different-billing">
      <label for="different-billing">Billing address different from shipping</label>
    </div>
    <div id="billing-fields" class="hidden">
      <label>Full Name</label><input type="text" id="bill-name">
      <label>Street Address</label><input type="text" id="bill-street">
      <label>Apartment, suite, etc. (optional)</label><input type="text" id="bill-apt">
      <label>City</label><input type="text" id="bill-city">
      <label>State / Province</label>
      <select id="bill-state">
        <option value="">-- Select --</option>
        <!-- same state list as above -->
      </select>
      <label>ZIP Code</label><input type="text" id="bill-zip" pattern="\d{5}">
    </div>
  </div>

  <!-- Order summary -->
  <div class="section summary">
    <div id="summary-lines"></div>
    <div class="total">Total: $<span id="final-total">0.00</span></div>
  </div>

  <div id="error-msg" class="error hidden"></div>
  <button id="pay-btn">Pay with Stripe</button>
</div>

<script>
  // ------------------------------------------------------------------
  // 1. Load cart & gift flag from URL
  // ------------------------------------------------------------------
  const params = new URLSearchParams(location.search);
  const rawCart = params.get('cart');
  const rawGift = params.get('gift');
  const cart = rawCart ? JSON.parse(decodeURIComponent(rawCart)) : [];
  let isGift = rawGift === 'true';

  // ------------------------------------------------------------------
  // 2. Populate cart summary (read-only)
  // ------------------------------------------------------------------
  const summaryEl = document.getElementById('cart-summary');
  if (cart.length === 0) {
    summaryEl.innerHTML = '<p>Your cart is empty.</p>';
  } else {
    const itemsHtml = cart.map(it => `
      <div style="display:flex;gap:12px;margin-bottom:12px;align-items:center;">
        <img src="${it.imageUrl}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;">
        <div style="flex:1;">
          <div style="font-weight:600;">${it.paletteName}</div>
          <div style="color:#666;font-size:0.9rem;">$${it.discountedPrice.toFixed(2)}</div>
        </div>
      </div>`).join('');
    summaryEl.innerHTML = `<h2>Your Items</h2>${itemsHtml}`;
  }

  // ------------------------------------------------------------------
  // 3. Gift checkbox – mirrors cart modal
  // ------------------------------------------------------------------
  const giftChk = document.getElementById('gift-checkbox');
  const giftHint = document.getElementById('gift-hint');
  giftChk.checked = isGift;
  giftHint.classList.toggle('hidden', !isGift);
  giftChk.addEventListener('change', () => {
    isGift = giftChk.checked;
    giftHint.classList.toggle('hidden', !isGift);
    recalcTotal();
  });

  // ------------------------------------------------------------------
  // 4. Billing address toggle
  // ------------------------------------------------------------------
  const diffBillChk = document.getElementById('different-billing');
  const billFields = document.getElementById('billing-fields');
  diffBillChk.addEventListener('change', () => {
    billFields.classList.toggle('hidden', !diffBillChk.checked);
  });

  // ------------------------------------------------------------------
  // 5. Dummy USPS-style address verification
  // ------------------------------------------------------------------
  function dummyVerifyAddress(addr) {
    // Very light validation – real integration will replace this
    const zip = addr.zip?.trim();
    const state = addr.state;
    if (!zip || !/^\d{5}$/.test(zip)) return 'Invalid ZIP code';
    if (!state) return 'State is required';
    return null; // OK
  }

  // ------------------------------------------------------------------
  // 6. Tax calculation (CA only, hidden otherwise)
  // ------------------------------------------------------------------
  const CA_TAX_RATE = 0.085; // 8.5 % – demo value
  function getTax(subtotal, shipState) {
    return shipState === 'CA' ? subtotal * CA_TAX_RATE : 0;
  }

  // ------------------------------------------------------------------
  // 7. Recalculate total (subtotal + gift + tax)
  // ------------------------------------------------------------------
  function recalcTotal() {
    const subtotal = cart.reduce((s, i) => s + i.discountedPrice, 0);
    const giftFee = isGift ? 12 : 0;
    const shipState = document.getElementById('ship-state').value;
    const tax = getTax(subtotal + giftFee, shipState);

    const lines = [];
    lines.push(`<line>Subtotal:<span>$${subtotal.toFixed(2)}</span></line>`);
    if (giftFee) lines.push(`<line>Gift service:<span style="color:#d4af37;">+$${giftFee.toFixed(2)}</span></line>`);
    if (tax > 0) lines.push(`<line>Sales tax (CA):<span>$${tax.toFixed(2)}</span></line>`);
    lines.push(`<line class="total">Total:<span>$${(subtotal + giftFee + tax).toFixed(2)}</span></line>`);

    document.getElementById('summary-lines').innerHTML = lines.join('');
    document.getElementById('final-total').textContent = (subtotal + giftFee + tax).toFixed(2);
    return {subtotal, giftFee, tax, total: subtotal + giftFee + tax};
  }

  // Initial calc
  recalcTotal();

  // Re-calc when shipping state changes
  document.getElementById('ship-state').addEventListener('change', recalcTotal);

  // ------------------------------------------------------------------
  // 8. Stripe redirect
  // ------------------------------------------------------------------
  const stripe = Stripe(CONFIG.STRIPE_PUBLISHABLE_KEY);
  const payBtn = document.getElementById('pay-btn');
  const errEl = document.getElementById('error-msg');

  payBtn.addEventListener('click', async () => {
    errEl.classList.add('hidden');
    payBtn.disabled = true;

    // ----- collect addresses -----
    const ship = {
      name: document.getElementById('ship-name').value.trim(),
      street: document.getElementById('ship-street').value.trim(),
      apt: document.getElementById('ship-apt').value.trim(),
      city: document.getElementById('ship-city').value.trim(),
      state: document.getElementById('ship-state').value,
      zip: document.getElementById('ship-zip').value.trim()
    };
    const bill = diffBillChk.checked ? {
      name: document.getElementById('bill-name').value.trim(),
      street: document.getElementById('bill-street').value.trim(),
      apt: document.getElementById('bill-apt').value.trim(),
      city: document.getElementById('bill-city').value.trim(),
      state: document.getElementById('bill-state').value,
      zip: document.getElementById('bill-zip').value.trim()
    } : ship;

    // ----- dummy verification -----
    const shipErr = dummyVerifyAddress(ship);
    if (shipErr) { showError(shipErr); return; }
    if (diffBillChk.checked) {
      const billErr = dummyVerifyAddress(bill);
      if (billErr) { showError('Billing: ' + billErr); return; }
    }

    // ----- final amount (cents) -----
    const {total} = recalcTotal();
    const amountCents = Math.round(total * 100);

    // ----- build payload exactly like the old Lambda expected -----
    const payload = {
      action: 'createCheckoutSession',
      user_email: null,               // will be filled by backend via JWT
      amount: amountCents,
      cart_items: cart,
      item_count: cart.length,
      is_gift: isGift,
      shipping_address: ship,
      billing_address: diffBillChk.checked ? bill : null
    };

    try {
      const sess = getSession();                 // from auth.js (same as before)
      const token = sess?.id_token;
      if (!token) throw new Error('Please sign in again');

      const resp = await fetch(CONFIG.CHECKOUT_API_ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        const txt = await resp.text();
        throw new Error(txt || 'Server error');
      }

      const {id: sessionId} = await resp.json();
      const {error} = await stripe.redirectToCheckout({sessionId});
      if (error) throw error;
    } catch (e) {
      showError(e.message || 'Checkout failed');
      payBtn.disabled = false;
    }
  });

  function showError(msg) {
    errEl.textContent = msg;
    errEl.classList.remove('hidden');
    payBtn.disabled = false;
  }

  // ------------------------------------------------------------------
  // 9. Gift title update
  // ------------------------------------------------------------------
  function updateShippingTitle() {
    const title = document.getElementById('shipping-title');
    title.textContent = isGift ? 'Gift Recipient Address' : 'Shipping Address';
  }
  giftChk.addEventListener('change', updateShippingTitle);
  updateShippingTitle();
</script>
</body>
</html>
