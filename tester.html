import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc } from 'firebase/firestore';

// --- Global Environment Variables (MANDATORY USE) ---
// These are provided by the canvas environment.
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- Brand Colors and Constants ---
const BRAND_MAGENTA = '#E6007E';
const BRAND_GOLD = '#D4AF37';
const BRAND_CHARCOAL = '#2E2E2E';

// Initialize Firebase (will be done in useEffect, but setting up the variables globally for clarity)
let db;
let auth;

// --- Utility Components ---

// A simple SVG icon representing a stylized flower/bloom
const BloomIcon = ({ className = 'w-6 h-6' }) => (
    <svg className={className} fill="none" stroke={BRAND_MAGENTA} viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364l-1.897 1.897a2.5 2.5 0 01-3.536 0L4.318 6.318zm0 0l-1.875-1.875a6 6 0 0110.607-1.414l1.414 1.414m-10.607 10.607l1.414 1.414a6 6 0 0010.607-1.414l-1.875-1.875" />
    </svg>
);

// --- Core Application Logic ---

const App = () => {
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [currentPage, setCurrentPage] = useState('Home');
    const [isNavOpen, setIsNavOpen] = useState(false);

    // 1. Firebase Initialization and Authentication
    useEffect(() => {
        // Only initialize once
        if (!Object.keys(firebaseConfig).length) {
            console.error("Firebase config is missing. Authentication will be skipped.");
            setIsAuthReady(true);
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            const unsubscribe = onAuthStateChanged(auth, async (user) => {
                if (user) {
                    setUserId(user.uid);
                    // Optional: Create a user document upon first sign-in (if it doesn't exist)
                    const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data');
                    await setDoc(userDocRef, { lastLogin: new Date().toISOString() }, { merge: true });
                } else {
                    setUserId(null);
                }
                setIsAuthReady(true);
            });

            // Attempt custom token sign-in first, fallback to anonymous
            const authenticate = async () => {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                        console.error("Custom token sign-in failed, trying anonymous:", e);
                        signInAnonymously(auth);
                    });
                } else {
                    signInAnonymously(auth);
                }
            };

            authenticate();
            return () => unsubscribe(); // Cleanup auth listener
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            setIsAuthReady(true);
        }
    }, []);

    // 2. Authentication Actions
    const handleLogout = useCallback(async () => {
        if (auth) {
            try {
                await signOut(auth);
                // After logout, sign back in anonymously to maintain a session context
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Logout failed:", error);
            }
        }
    }, []);

    const handleLoginPlaceholder = useCallback(() => {
        // Since we are using token/anonymous sign-in, this button acts as a trigger
        // for a future proper login flow (e.g., Google sign-in).
        alert('Login flow placeholder: Implement proper sign-in method here.');
    }, []);

    // 3. User Interface Components

    const NavItem = ({ name }) => (
        <button
            onClick={() => {
                setCurrentPage(name);
                setIsNavOpen(false);
            }}
            className={`px-4 py-2 font-serif text-sm transition-all duration-200 rounded-lg hover:text-white ${currentPage === name ? 'text-white bg-opacity-90 bg-['+BRAND_MAGENTA+']' : 'text-['+BRAND_CHARCOAL+'] hover:bg-['+BRAND_MAGENTA+'] hover:bg-opacity-10'}`}
        >
            {name}
        </button>
    );

    const Navbar = () => (
        <nav className="bg-white/90 backdrop-blur-sm shadow-lg sticky top-0 z-50 transition-all duration-300">
            <div className="container mx-auto px-4 sm:px-6 lg:px-8">
                <div className="flex justify-between items-center h-16">
                    {/* Brand/Logo */}
                    <div className="flex-shrink-0 flex items-center">
                        <BloomIcon className="w-8 h-8 mr-2" />
                        <span className="text-xl font-bold font-serif italic" style={{ color: BRAND_CHARCOAL }}>
                            theweer.com
                        </span>
                    </div>

                    {/* Desktop Navigation */}
                    <div className="hidden md:flex space-x-4 items-center">
                        <NavItem name="Home" />
                        <NavItem name="The Encounter" />
                        <NavItem name="Artistry" />
                        <NavItem name="My Bloom" />
                        <NavItem name="Contact" />
                        
                        {/* Auth Status & Button */}
                        {isAuthReady && (
                            userId ? (
                                <button
                                    onClick={handleLogout}
                                    className="px-4 py-2 text-sm font-semibold text-white rounded-full transition-all duration-300 transform active:scale-95 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2"
                                    style={{ backgroundColor: BRAND_MAGENTA, borderColor: BRAND_MAGENTA, transition: 'background-color 0.2s' }}
                                >
                                    Sign Out
                                </button>
                            ) : (
                                <button
                                    onClick={handleLoginPlaceholder}
                                    className="px-4 py-2 text-sm font-semibold text-['+BRAND_CHARCOAL+'] rounded-full border transition-all duration-300 hover:bg-['+BRAND_MAGENTA+'] hover:text-white transform active:scale-95"
                                    style={{ borderColor: BRAND_MAGENTA }}
                                >
                                    Log In
                                </button>
                            )
                        )}
                    </div>

                    {/* Mobile Menu Button */}
                    <div className="md:hidden">
                        <button
                            onClick={() => setIsNavOpen(!isNavOpen)}
                            className="inline-flex items-center justify-center p-2 rounded-md text-['+BRAND_MAGENTA+'] hover:text-white hover:bg-['+BRAND_MAGENTA+'] focus:outline-none focus:ring-2 focus:ring-inset focus:ring-['+BRAND_MAGENTA+']"
                        >
                            <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                {isNavOpen ? (
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                                ) : (
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" />
                                )}
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            {/* Mobile Menu Content */}
            <div className={`md:hidden transition-all duration-300 ease-in-out overflow-hidden ${isNavOpen ? 'max-h-96 opacity-100 py-2' : 'max-h-0 opacity-0'}`}>
                <div className="px-2 pt-2 pb-3 space-y-1 sm:px-3 flex flex-col items-start">
                    <NavItem name="Home" />
                    <NavItem name="The Encounter" />
                    <NavItem name="Artistry" />
                    <NavItem name="My Bloom" />
                    <NavItem name="Contact" />
                    <div className="mt-4 w-full">
                        {isAuthReady && (
                            userId ? (
                                <button
                                    onClick={handleLogout}
                                    className="w-full text-center px-4 py-2 text-sm font-semibold text-white rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2"
                                    style={{ backgroundColor: BRAND_MAGENTA }}
                                >
                                    Sign Out
                                </button>
                            ) : (
                                <button
                                    onClick={handleLoginPlaceholder}
                                    className="w-full text-center px-4 py-2 text-sm font-semibold border rounded-lg hover:bg-['+BRAND_MAGENTA+'] hover:text-white"
                                    style={{ color: BRAND_CHARCOAL, borderColor: BRAND_MAGENTA }}
                                >
                                    Log In
                                </button>
                            )
                        )}
                    </div>
                </div>
            </div>
        </nav>
    );

    // 4. Page Content based on current module (for easy integration)
    const PageContent = () => {
        const titleStyle = { color: BRAND_MAGENTA };
        const textStyle = { color: BRAND_CHARCOAL };
        const subTitleStyle = { color: BRAND_GOLD };

        // Modular structure for you to build out the different sections
        switch (currentPage) {
            case 'Home':
                return (
                    <div className="min-h-[70vh] flex flex-col justify-center items-center text-center p-8 bg-white/50">
                        <h1 className="text-5xl md:text-7xl font-serif italic mb-4" style={titleStyle}>
                            Your reflection is waiting to bloom.
                        </h1>
                        <p className="text-xl md:text-2xl max-w-3xl mb-8 font-light" style={textStyle}>
                            **She took a selfie. The flowers took over.**
                        </p>
                        <p className="text-lg font-light italic" style={subTitleStyle}>
                            Where technology meets the tenderness of art.
                        </p>
                        <div className="mt-12 p-4 rounded-xl shadow-xl border-t-4 border-['+BRAND_MAGENTA+']" style={{ backgroundColor: '#fff' }}>
                            <p className="text-sm font-medium" style={textStyle}>
                                Current User Session: <span className="font-mono text-xs text-gray-500">{isAuthReady ? (userId || 'Not Logged In') : 'Loading...'}</span>
                            </p>
                            <p className="text-sm font-medium" style={textStyle}>
                                User ID (for collaboration): <span className="font-mono text-xs text-['+BRAND_CHARCOAL+'] break-all">{userId || 'N/A'}</span>
                            </p>
                        </div>
                    </div>
                );
            case 'The Encounter':
                return (
                    <div className="p-8">
                        <h2 className="text-4xl font-serif mb-4" style={titleStyle}>The Experience Flow</h2>
                        <p className="text-lg mb-6 max-w-4xl" style={textStyle}>
                            This is where we capture the poetic instructions from your tent:
                        </p>
                        <ul className="space-y-4 text-xl list-none p-0">
                            {[
                                "Scan the code.",
                                "Upload your 3 photos.",
                                "Watch your hair blossom into art.",
                                "See your wallpaper and case merge as one.",
                                "Pick it up â€” or have it find you later."
                            ].map((step, index) => (
                                <li key={index} className="flex items-center text-['+BRAND_CHARCOAL+']">
                                    <span className="text-3xl font-bold mr-4" style={titleStyle}>
                                        {index + 1}.
                                    </span>
                                    {step}
                                </li>
                            ))}
                        </ul>
                    </div>
                );
            case 'Artistry':
                return (
                    <div className="p-8">
                        <h2 className="text-4xl font-serif mb-4" style={titleStyle}>The Craft Wall</h2>
                        <p className="text-lg max-w-4xl" style={textStyle}>
                            "Every bloom here began as a reflection." This module is where you will integrate the AI image generation logic.
                        </p>
                        <div className="mt-6 p-6 rounded-lg border border-['+BRAND_GOLD+'] bg-white shadow-inner">
                            <p className="italic text-gray-600">Placeholder for Image Upload and AI Generation Component.</p>
                        </div>
                    </div>
                );
            case 'My Bloom':
                return (
                    <div className="p-8">
                        <h2 className="text-4xl font-serif mb-4" style={titleStyle}>Your Personal Portrait</h2>
                        <p className="text-lg max-w-4xl" style={textStyle}>
                            Access your saved designs and orders here. This section will rely heavily on the Firestore structure to retrieve private user data.
                        </p>
                        <div className="mt-6 p-6 rounded-lg border border-['+BRAND_CHARCOAL+'] bg-white shadow-inner">
                            <p className="italic text-gray-600">Placeholder for User Dashboard/Order History.</p>
                        </div>
                    </div>
                );
            case 'Contact':
                return (
                    <div className="p-8">
                        <h2 className="text-4xl font-serif mb-4" style={titleStyle}>Find Us</h2>
                        <p className="text-lg max-w-4xl" style={textStyle}>
                            Connect with us. We are motion and bloom.
                        </p>
                    </div>
                );
            default:
                return null;
        }
    };

    return (
        <div className="min-h-screen bg-gray-50 antialiased font-sans transition-all duration-300">
            <style>{`
                /* Ensure a clean, elegant look */
                .font-serif {
                    font-family: 'Georgia', 'Times New Roman', serif;
                }
                .font-sans {
                    font-family: 'Inter', sans-serif;
                }
            `}</style>
            
            <Navbar />
            <main className="container mx-auto p-0 pt-16">
                <PageContent />
            </main>
            
            {/* Footer with Branding */}
            <footer className="mt-20 p-8 text-center" style={{ backgroundColor: BRAND_CHARCOAL }}>
                <p className="text-white text-sm opacity-70">
                    {/* Tagline Lockup */}
                    <span className="text-lg font-serif italic" style={{ color: BRAND_GOLD }}>
                        Your reflection. Reimagined in bloom.
                    </span>
                    <br/>
                    <span className="mt-1 block">
                        &copy; {new Date().getFullYear()} Theweer. All rights reserved.
                    </span>
                </p>
            </footer>
        </div>
    );
};

export default App;
