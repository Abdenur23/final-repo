<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cognito Auth Tester</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
.container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
h1,h2,h3 { color:#333; }
#auth-action { margin-bottom: 20px; }
#auth-action button { padding:10px 20px; font-size:16px; background-color:#f90; color:white; border:none; border-radius:5px; cursor:pointer; margin: 5px; }
#token-display pre { background:#eee; padding:10px; border-radius:4px; overflow-x:auto; }
.debug-info { background: #fff3cd; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; font-size: 12px; }
</style>
</head>
<body>

<div class="container">
    <h1>AWS Cognito Authentication Status</h1>
    <div id="auth-action"></div>
    <div id="debug-info" class="debug-info"></div>
    <div id="token-display"><h2>Not signed in</h2></div>
</div>

<script>
// Debug function to test different endpoints
function debugAuthEndpoints() {
    const debugDiv = document.getElementById('debug-info');
    const clientId = '73lf1h32phkqeb9ahu6tqcl9av';
    const domain = 'auth.theweer.com';
    const redirectUri = 'https://theweer.com/tester.html';
    
    const endpoints = [
        {
            name: 'OAuth2 Authorize',
            url: `https://${domain}/oauth2/authorize?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=email+openid+profile`
        },
        {
            name: 'Login (Legacy)',
            url: `https://${domain}/login?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=email+openid+profile`
        },
        {
            name: 'OAuth2 Metadata',
            url: `https://${domain}/.well-known/oauth-authorization-server`
        },
        {
            name: 'OpenID Configuration',
            url: `https://${domain}/.well-known/openid-configuration`
        }
    ];
    
    let debugHTML = '<h3>Debug Endpoints:</h3>';
    endpoints.forEach(endpoint => {
        debugHTML += `
            <div style="margin: 10px 0;">
                <strong>${endpoint.name}:</strong><br>
                <a href="${endpoint.url}" target="_blank" style="font-size: 11px; word-break: break-all;">${endpoint.url}</a>
            </div>
        `;
    });
    
    debugDiv.innerHTML = debugHTML;
}

// Test the OAuth2 metadata endpoint
async function testOAuthConfig() {
    const domain = 'auth.theweer.com';
    try {
        const response = await fetch(`https://${domain}/.well-known/oauth-authorization-server`);
        if (response.ok) {
            const config = await response.json();
            console.log('OAuth2 Configuration:', config);
            document.getElementById('debug-info').innerHTML += `
                <div style="background: #d4edda; padding: 10px; margin: 10px 0;">
                    <strong>OAuth2 Config Found:</strong><br>
                    Authorization Endpoint: ${config.authorization_endpoint}<br>
                    Token Endpoint: ${config.token_endpoint}
                </div>
            `;
            return config;
        }
    } catch (error) {
        console.log('OAuth2 metadata not available, trying OpenID config...');
        try {
            const response = await fetch(`https://${domain}/.well-known/openid-configuration`);
            if (response.ok) {
                const config = await response.json();
                console.log('OpenID Configuration:', config);
                document.getElementById('debug-info').innerHTML += `
                    <div style="background: #d4edda; padding: 10px; margin: 10px 0;">
                        <strong>OpenID Config Found:</strong><br>
                        Authorization Endpoint: ${config.authorization_endpoint}<br>
                        Token Endpoint: ${config.token_endpoint}
                    </div>
                `;
                return config;
            }
        } catch (error2) {
            console.log('No configuration endpoints available');
            document.getElementById('debug-info').innerHTML += `
                <div style="background: #f8d7da; padding: 10px; margin: 10px 0;">
                    <strong>No OAuth2/OpenID configuration found.</strong><br>
                    This suggests the Cognito domain may not be properly configured.
                </div>
            `;
        }
    }
    return null;
}

// Try different authorization methods
function tryAuthorization() {
    const clientId = '73lf1h32phkqeb9ahu6tqcl9av';
    const domain = 'auth.theweer.com';
    const redirectUri = 'https://theweer.com/tester.html';
    
    // Method 1: Standard OAuth2 with PKCE
    const verifier = genRandom();
    localStorage.setItem('pkce_verifier', verifier);
    
    sha256(verifier).then(challenge => {
        // Try the standard OAuth2 authorize endpoint
        const authUrl = `https://${domain}/oauth2/authorize?` + new URLSearchParams({
            response_type: 'code',
            client_id: clientId,
            redirect_uri: redirectUri,
            scope: 'email openid profile',
            code_challenge_method: 'S256',
            code_challenge: challenge
        });
        
        console.log('Trying OAuth2 endpoint:', authUrl);
        window.location.href = authUrl;
    });
}

function tryLegacyAuthorization() {
    const clientId = '73lf1h32phkqeb9ahu6tqcl9av';
    const domain = 'auth.theweer.com';
    const redirectUri = 'https://theweer.com/tester.html';
    
    // Method 2: Legacy endpoint (if OAuth2 doesn't work)
    const legacyUrl = `https://${domain}/login?` + new URLSearchParams({
        response_type: 'code',
        client_id: clientId,
        redirect_uri: redirectUri,
        scope: 'email openid profile'
    });
    
    console.log('Trying legacy endpoint:', legacyUrl);
    window.location.href = legacyUrl;
}

// PKCE helpers
function base64urlencode(str){
    return btoa(String.fromCharCode.apply(null, new Uint8Array(str)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

async function sha256(buffer){
    const digest = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(buffer));
    return base64urlencode(digest);
}

function genRandom(){ 
    const arr = new Uint8Array(32); 
    crypto.getRandomValues(arr); 
    return base64urlencode(arr);
}

// Handle OAuth callback
async function handleCodeExchange(){
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    const error = params.get('error');
    
    const debugDiv = document.getElementById('debug-info');
    
    if (error) {
        debugDiv.innerHTML += `
            <div style="background: #f8d7da; padding: 10px; margin: 10px 0;">
                <strong>OAuth Error:</strong> ${error}<br>
                Description: ${params.get('error_description')}
            </div>
        `;
        return;
    }
    
    if (code) {
        debugDiv.innerHTML += `
            <div style="background: #d4edda; padding: 10px; margin: 10px 0;">
                <strong>Authorization Code Received!</strong><br>
                Code: ${code.substring(0, 20)}...
            </div>
        `;
        
        // Try to exchange code for tokens
        const verifier = localStorage.getItem('pkce_verifier');
        if (verifier) {
            const tokenUrl = `https://auth.theweer.com/oauth2/token`;
            const body = new URLSearchParams({
                grant_type: 'authorization_code',
                client_id: '73lf1h32phkqeb9ahu6tqcl9av',
                code: code,
                redirect_uri: 'https://theweer.com/tester.html',
                code_verifier: verifier
            });
            
            try {
                const response = await fetch(tokenUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: body
                });
                
                if (response.ok) {
                    const tokens = await response.json();
                    localStorage.setItem('cognitoSession', JSON.stringify(tokens));
                    debugDiv.innerHTML += `
                        <div style="background: #d4edda; padding: 10px; margin: 10px 0;">
                            <strong>Tokens Received Successfully!</strong><br>
                            ID Token: ${tokens.id_token ? 'Yes' : 'No'}<br>
                            Access Token: ${tokens.access_token ? 'Yes' : 'No'}
                        </div>
                    `;
                } else {
                    const errorText = await response.text();
                    debugDiv.innerHTML += `
                        <div style="background: #f8d7da; padding: 10px; margin: 10px 0;">
                            <strong>Token Exchange Failed:</strong><br>
                            Status: ${response.status}<br>
                            Error: ${errorText}
                        </div>
                    `;
                }
            } catch (error) {
                debugDiv.innerHTML += `
                    <div style="background: #f8d7da; padding: 10px; margin: 10px 0;">
                        <strong>Token Exchange Error:</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }
        
        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
}

function showAuthUI() {
    document.getElementById('auth-action').innerHTML = `
        <button onclick="tryAuthorization()">Sign In (OAuth2)</button>
        <button onclick="tryLegacyAuthorization()">Sign In (Legacy)</button>
        <button onclick="signout()">Sign Out</button>
    `;
}

function signout() {
    localStorage.removeItem('cognitoSession');
    localStorage.removeItem('pkce_verifier');
    window.location.href = `https://auth.theweer.com/logout?client_id=73lf1h32phkqeb9ahu6tqcl9av&logout_uri=${encodeURIComponent('https://theweer.com/tester.html')}`;
}

function showSessionInfo() {
    const session = JSON.parse(localStorage.getItem('cognitoSession') || 'null');
    const div = document.getElementById('token-display');
    
    if (session?.id_token) {
        try {
            const payload = JSON.parse(atob(session.id_token.split('.')[1]));
            div.innerHTML = `<h2>Signed in as ${payload.email || payload.sub}</h2><pre>${JSON.stringify(payload, null, 2)}</pre>`;
        } catch (error) {
            div.innerHTML = `<h2>Signed in (token parsing error)</h2>`;
        }
    } else {
        div.innerHTML = `<h2>Not signed in</h2>`;
    }
}

// Initialize
async function initializeApp() {
    debugAuthEndpoints();
    await testOAuthConfig();
    await handleCodeExchange();
    showAuthUI();
    showSessionInfo();
}

initializeApp();
</script>
</body>
</html>
