<!DOCTYPE html>
<html>
<head>
    <title>Simple API Test</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        button { 
            padding: 15px 30px; 
            font-size: 18px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #result { margin-top: 20px; padding: 10px; }
        .warning { color: orange; }
        .error { color: red; }
        .success { color: green; }
        .auth-section { 
            margin-bottom: 20px; 
            padding: 15px; 
            background: #f0f0f0; 
            border-radius: 5px; 
        }
    </style>
</head>
<body>
    <h1>Simple API Test</h1>
    <div id="auth-status" class="auth-section">
        Checking authentication status...
    </div>
    <button onclick="callApi()" id="apiButton" disabled>Click to Call API</button>
    <div id="result"></div>

    <!-- Use your existing auth.js -->
    <script src="auth.js"></script>

    <script>
        const API_URL = 'https://rd8hnh5ch6.execute-api.us-east-1.amazonaws.com/prod/add-record';

        // Modified checkAuthStatus for tester page
        function checkAuthForTester() {
            const authStatus = document.getElementById('auth-status');
            const apiButton = document.getElementById('apiButton');
            
            // Check if we have the cognitoToken (your existing auth system)
            const cognitoToken = localStorage.getItem('cognitoToken');
            
            if (cognitoToken) {
                authStatus.innerHTML = `
                    <div class="success">✅ You are signed in</div>
                    <div><small>Using existing authentication</small></div>
                    <button onclick="signOut()" class="btn-secondary">Sign Out</button>
                `;
                apiButton.disabled = false;
            } else {
                authStatus.innerHTML = `
                    <div class="error">❌ Not authenticated</div>
                    <button onclick="signIn()" class="btn-primary">Sign In</button>
                `;
                apiButton.disabled = true;
            }
        }

        // Modified API call that works with your current setup
        async function callApi() {
            const button = document.getElementById('apiButton');
            const resultDiv = document.getElementById('result');
            
            button.disabled = true;
            button.textContent = 'Calling API...';
            resultDiv.innerHTML = '';

            try {
                // Since your current auth doesn't store real JWT tokens,
                // we need to get a fresh token using the implicit grant flow
                const token = await getFreshToken();
                
                if (!token) {
                    throw new Error('Could not get authentication token');
                }

                console.log('Making API call with token...');
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">✅ Success! Record added for user: ${data.user_sub}</div>`;
                    console.log('API response:', data);
                } else {
                    throw new Error(data.message || `API call failed with status: ${response.status}`);
                }

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
                console.error('API call failed:', error);
            } finally {
                button.disabled = false;
                button.textContent = 'Click to Call API';
            }
        }

        // Function to get a fresh token using implicit grant
        async function getFreshToken() {
            // Since your current system doesn't store JWT tokens,
            // we'll redirect to Cognito to get a fresh token
            return new Promise((resolve) => {
                // Store the current URL to return here after auth
                localStorage.setItem('returnUrl', window.location.href);
                
                // Redirect to Cognito with implicit grant to get token directly
                const cognitoConfig = {
                    clientId: '7irso7dmmnp793egs9bhkl0t81',
                    domain: 'auth.theweer.com',
                    redirectUri: window.location.origin + window.location.pathname
                };
                
                const redirectUri = encodeURIComponent(cognitoConfig.redirectUri);
                const implicitUrl = `https://${cognitoConfig.domain}/oauth2/authorize?client_id=${cognitoConfig.clientId}&response_type=token&scope=email+openid&redirect_uri=${redirectUri}`;
                
                window.location.href = implicitUrl;
            });
        }

        // Check for token in URL (implicit grant callback)
        function checkForTokenInURL() {
            const urlParams = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = urlParams.get('access_token');
            const idToken = urlParams.get('id_token');
            
            if (accessToken || idToken) {
                // We got tokens! Store them and clean up URL
                if (idToken) {
                    localStorage.setItem('idToken', idToken);
                }
                if (accessToken) {
                    localStorage.setItem('accessToken', accessToken);
                }
                
                // Clear the tokens from URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Enable API button
                document.getElementById('apiButton').disabled = false;
                document.getElementById('auth-status').innerHTML = 
                    '<div class="success">✅ Got fresh tokens! Ready to call API.</div>';
                
                return idToken || accessToken;
            }
            return null;
        }

        // Initialize
        window.addEventListener('load', function() {
            // First check if we have tokens in URL (implicit grant callback)
            const token = checkForTokenInURL();
            
            if (token) {
                // We have fresh tokens from implicit flow
                console.log('Got fresh token from implicit flow');
            } else {
                // Use your existing auth system
                checkAuthForTester();
            }
        });
    </script>
</body>
</html>
