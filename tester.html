<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PKCE with Default Domain</title>
</head>
<body>
    <h1>PKCE with Default Cognito Domain</h1>
    <button onclick="startPKCE()">Start PKCE Flow</button>
    <div id="result" style="margin-top: 20px;"></div>

    <script>
        // Use the DEFAULT Cognito domain (not custom domain)
        const config = {
            clientId: '73lf1h32phkqeb9ahu6tqcl9av',
            redirectUri: 'https://theweer.com/tester.html',
            // Use your default Cognito domain (find this in AWS Console)
            cognitoDomain: 'https://us-east-1tjdoamtpp.auth.us-east-1.amazoncognito.com' // ← CHANGE THIS
        };

        function generateRandomString(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            let result = '';
            const randomValues = new Uint8Array(length);
            crypto.getRandomValues(randomValues);
            for (let i = 0; i < length; i++) {
                result += chars[randomValues[i] % chars.length];
            }
            return result;
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        async function startPKCE() {
            try {
                const codeVerifier = generateRandomString(64);
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                
                localStorage.setItem('pkce_verifier', codeVerifier);
                
                const authUrl = new URL(`${config.cognitoDomain}/oauth2/authorize`);
                authUrl.searchParams.append('client_id', config.clientId);
                authUrl.searchParams.append('response_type', 'code');
                authUrl.searchParams.append('scope', 'email openid profile');
                authUrl.searchParams.append('redirect_uri', config.redirectUri);
                authUrl.searchParams.append('code_challenge_method', 'S256');
                authUrl.searchParams.append('code_challenge', codeChallenge);
                
                console.log('PKCE Auth URL:', authUrl.toString());
                window.location.href = authUrl.toString();
                
            } catch (error) {
                document.getElementById('result').innerHTML = `Error: ${error.message}`;
            }
        }

        async function handleCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            const resultDiv = document.getElementById('result');
            
            if (error) {
                resultDiv.innerHTML = `❌ Error: ${error} - ${urlParams.get('error_description')}`;
                return;
            }
            
            if (code) {
                try {
                    const codeVerifier = localStorage.getItem('pkce_verifier');
                    const tokenResponse = await fetch(`${config.cognitoDomain}/oauth2/token`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: new URLSearchParams({
                            grant_type: 'authorization_code',
                            client_id: config.clientId,
                            code: code,
                            redirect_uri: config.redirectUri,
                            code_verifier: codeVerifier
                        })
                    });
                    
                    const tokens = await tokenResponse.json();
                    
                    if (tokenResponse.ok) {
                        resultDiv.innerHTML = `✅ PKCE Success! Tokens received.`;
                        localStorage.removeItem('pkce_verifier');
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } else {
                        throw new Error(tokens.error || 'Token exchange failed');
                    }
                    
                } catch (error) {
                    resultDiv.innerHTML = `❌ Token exchange failed: ${error.message}`;
                }
            }
        }

        if (window.location.search.includes('code=') || window.location.search.includes('error=')) {
            handleCallback();
        }
    </script>
</body>
</html>
