
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cognito Auth Tester</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
.container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
h1,h2,h3 { color:#333; }
#auth-action { margin-bottom: 20px; }
#auth-action button { padding:10px 20px; font-size:16px; background-color:#f90; color:white; border:none; border-radius:5px; cursor:pointer; margin: 0 5px; }
#token-display pre { background:#eee; padding:10px; border-radius:4px; overflow-x:auto; }
#token-display textarea { width:100%; height:100px; padding:10px; box-sizing:border-box; border:1px solid #ccc; border-radius:4px; resize:none; font-family:monospace; }
#uploadSection { margin-top:20px; }
#uploadSection input { margin-bottom:10px; }
#uploadSection button { padding:10px 20px; font-size:16px; background-color:#28a745; color:white; border:none; border-radius:5px; cursor:pointer; }
#uploadResult { margin-top:10px; font-weight:bold; }

/* Product Display Styles */
#productDisplay { margin-top: 30px; }
#productGallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
.product-item { text-align: center; }
.product-image { max-width: 100%; height: auto; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
.product-image.popped { 
    max-width: 90vw; 
    position: fixed; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    z-index: 1000; 
    background: white; 
    padding: 20px; 
    border-radius: 12px; 
    box-shadow: 0 0 30px rgba(0,0,0,0.5); 
    cursor: zoom-out; 
}
.product-info { margin-top: 10px; }
.product-price { color: #f90; font-weight: bold; }

/* Real-time Updates Styles */
#updatesPanel { margin-top: 30px; border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f9f9f9; }
#updatesContainer { max-height: 400px; overflow-y: auto; }
.update-item { margin: 10px 0; padding: 10px; border: 1px solid #eee; border-radius: 5px; background: white; }
.update-image { max-width: 100%; height: auto; border-radius: 5px; cursor: pointer; }
.update-image.popped { 
    max-width: 90vw; 
    position: fixed; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    z-index: 1000; 
    background: white; 
    padding: 20px; 
    border-radius: 12px; 
    box-shadow: 0 0 30px rgba(0,0,0,0.5); 
    cursor: zoom-out; 
}
</style>
</head>
<body>

<div class="container">
    <h1>AWS Cognito Authentication Status</h1>
    <div id="auth-action"></div>

    <div id="token-display"><h2>Not signed in</h2></div>

    <div id="uploadSection" style="display:none;">
        <h2>Upload 3 Images</h2>
        <input type="file" id="fileInput" multiple accept="image/*">
        <br>
        <button onclick="uploadFiles()">Upload</button>
        <div id="uploadResult"></div>
    </div>

    <!-- Product Display Section -->
    <div id="productDisplay" style="display:none;">
        <h2>Your Products</h2>
        <div id="productGallery">
            <!-- Product images will be inserted here -->
        </div>
    </div>

    <!-- Real-time Updates Panel -->
    <div id="updatesPanel" style="display:none;">
        <h3>Processing Updates</h3>
        <div id="updatesContainer"></div>
    </div>
</div>

<script>
const cognitoConfig = {
    clientId: '7irso7dmmnp793egs9bhkl0t81',
    domain: 'auth.theweer.com',
    redirectUri: window.location.origin + window.location.pathname
};

// Authentication Functions
function saveSession(tokens){ localStorage.setItem('cognitoSession', JSON.stringify(tokens)); }
function getSession(){ return JSON.parse(localStorage.getItem('cognitoSession')); }

function showAuthUI(){ 
    const authDiv = document.getElementById('auth-action');
    authDiv.innerHTML = `
        <button onclick="signin()">Sign In / Sign Up</button>
        <button onclick="signout()">Sign Out</button>
    `;
}

function signin(){
    window.location.href = `https://${cognitoConfig.domain}/login?client_id=${cognitoConfig.clientId}&response_type=token&scope=email+openid+profile&redirect_uri=${encodeURIComponent(cognitoConfig.redirectUri)}`;
}

function signout(){
    localStorage.removeItem('cognitoSession');
    window.location.href = `https://${cognitoConfig.domain}/logout?client_id=${cognitoConfig.clientId}&logout_uri=${encodeURIComponent(window.location.origin)}`;
}

function parseHashTokens(){
    if(location.hash){
        const hash = location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const id_token = params.get('id_token');
        const access_token = params.get('access_token');
        if(id_token && access_token){
            saveSession({id_token, access_token});
            location.hash = '';
        }
    }
}

function showSessionInfo(){
    const session = getSession();
    const tokenDiv = document.getElementById('token-display');
    if(session && session.id_token){
        const payload = JSON.parse(atob(session.id_token.split('.')[1]));
        tokenDiv.innerHTML = `<h2>Signed in as ${payload.sub}</h2>
        <pre>${JSON.stringify(payload, null, 2)}</pre>`;
        document.getElementById('uploadSection').style.display = 'block';
    } else {
        tokenDiv.innerHTML = `<h2>Not signed in</h2>`;
        document.getElementById('uploadSection').style.display = 'none';
    }
}

// File Upload Functions
let selectedFiles = [];
document.getElementById('fileInput').addEventListener('change', (e)=>{
    selectedFiles = Array.from(e.target.files);
    if(selectedFiles.length !== 3) alert("Please select exactly 3 images");
});

async function uploadFiles(){
    const token = getSession()?.id_token;
    if(!token || selectedFiles.length !==3) return alert('Sign in and select exactly 3 images');

    const filesData = selectedFiles.map((f,i)=>({fileId:i+1, fileName:f.name, fileType:f.type}));

    // Step 1: Get presigned URLs from Lambda
    const res = await fetch('https://y4vn8tdr5g.execute-api.us-east-1.amazonaws.com/prod/upload', {
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':token},
        body: JSON.stringify({ files: filesData })
    });

    const data = await res.json();
    const resultDiv = document.getElementById('uploadResult');

    if(!res.ok || !data.uploadUrls){ 
        resultDiv.innerHTML = `❌ Upload failed: ${data.error || JSON.stringify(data)}`;
        return;
    }

    // Step 2: Upload files to S3 using presigned URLs and notify completion
    try{
        const uploadPromises = data.uploadUrls.map(async (u, idx) => {
            // Upload file to S3
            const uploadResponse = await fetch(u.uploadUrl, { 
                method:'PUT', 
                body:selectedFiles[idx], 
                headers:{'Content-Type':selectedFiles[idx].type} 
            });
            
            if (uploadResponse.ok) {
                // Notify server about upload completion
                const notificationPayload = {
                    action: 'uploadComplete',
                    fileKey: u.key,
                    metadata: {
                        fileName: u.fileName,
                        priority: u.priority,
                        srcid: u.srcid,
                        palette_id: u.palette_id,
                        flavor: u.flavor,
                        cid: data.cid
                    }
                };
                
                // Send completion notification (fire and forget)
                fetch('https://y4vn8tdr5g.execute-api.us-east-1.amazonaws.com/prod/upload', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'Authorization': token},
                    body: JSON.stringify(notificationPayload)
                }).then(response => {
                    if (!response.ok) {
                        console.log('Notification failed:', response.status);
                    } else {
                        console.log(`Upload completion notified for: ${u.fileName}`);
                    }
                }).catch(err => console.log('Notification error:', err));
            }
            
            return uploadResponse;
        });
        
        await Promise.all(uploadPromises);
        resultDiv.innerHTML = `✅ All 3 files uploaded successfully!`;
        showUpdatesPanel();
    } catch(e){
        resultDiv.innerHTML = `❌ Error uploading files: ${e.message}`;
    }
}

// Product Display Functions
function displayProduct(imageUrl, productName, price = "$34") {
    const gallery = document.getElementById('productGallery');
    const productDiv = document.createElement('div');
    productDiv.className = 'product-item';
    productDiv.innerHTML = `
        <div class="product-image-container">
            <img src="${imageUrl}" 
                 alt="${productName}" 
                 class="product-image"
                 onclick="toggleImagePopup(this)">
            <div class="product-info">
                <strong>${productName}</strong><br>
                <span class="product-price">${price}</span>
            </div>
        </div>
    `;
    gallery.appendChild(productDiv);
}

function showProductDisplay() {
    document.getElementById('productDisplay').style.display = 'block';
}

// Image Popup Function (works for both products and updates)
function toggleImagePopup(imgElement) {
    if (imgElement.classList.contains('popped')) {
        // Return to normal
        imgElement.classList.remove('popped');
    } else {
        // Pop to full view
        imgElement.classList.add('popped');
    }
}

// Real-time Updates Functions
function showUpdatesPanel() {
    document.getElementById('updatesPanel').style.display = 'block';
}

function addUpdate(imageUrl, fileName, stage) {
    const container = document.getElementById('updatesContainer');
    const updateDiv = document.createElement('div');
    updateDiv.className = 'update-item';
    updateDiv.innerHTML = `
        <img src="${imageUrl}" 
             alt="${fileName}" 
             class="update-image"
             onclick="toggleImagePopup(this)">
        <div><strong>${stage}</strong> - ${fileName}</div>
    `;
    container.insertBefore(updateDiv, container.firstChild);
}

// Example: Simulate receiving product images (replace with actual backend calls)
function simulateProductReceipt() {
    // This would be called when your backend sends product images
    displayProduct('https://via.placeholder.com/307x408/4A90E2/FFFFFF?text=Product+1', 'Custom Phone Case', '$34');
    displayProduct('https://via.placeholder.com/307x408/50E3C2/FFFFFF?text=Product+2', 'Premium Case', '$34');
    displayProduct('https://via.placeholder.com/307x408/9013FE/FFFFFF?text=Product+3', 'Designer Case', '$34');
    showProductDisplay();
}

// Example: Simulate processing updates (replace with WebSocket messages)
function simulateProcessingUpdates() {
    addUpdate('https://via.placeholder.com/200x200/4A90E2/FFFFFF?text=Processing', 'image1.jpg', 'Enhancing');
    addUpdate('https://via.placeholder.com/200x200/50E3C2/FFFFFF?text=Processing', 'image2.jpg', 'Background Removal');
    addUpdate('https://via.placeholder.com/200x200/9013FE/FFFFFF?text=Processing', 'image3.jpg', 'Finalizing');
}

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    parseHashTokens();
    showAuthUI();
    showSessionInfo();
    
    // Simulate receiving products (remove this in production)
    setTimeout(simulateProductReceipt, 2000);
});

// Uncomment to simulate updates panel (remove in production)
// showUpdatesPanel();
// simulateProcessingUpdates();
</script>
</body>
</html>
