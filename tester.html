<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bloom - Your Reflection is Waiting to Bloom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Dreamlike Elegance Theme --- */
        :root {
            --color-magenta: #E6007E;
            --color-gold: #D4AF37;
            --color-charcoal: #2E2E2E;
            --color-blush-start: #FFD0E6;
            --color-blush-end: #FFF7FB;
        }

        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=Manrope:wght@400;600&display=swap');

        body {
            font-family: 'Manrope', sans-serif;
            background-color: var(--color-blush-end);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: var(--color-charcoal);
        }
        .container {
            width: 100%;
            max-width: 960px; /* Increased max-width for artistic content */
            background: white;
            padding: 32px;
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }
        .header {
            border-bottom: 1px solid var(--color-blush-start);
        }
        h1, h2, h3, .poetic-title {
            font-family: 'Cormorant Garamond', serif;
            letter-spacing: 0.05em;
        }
        .poetic-title {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--color-charcoal);
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .cta-magenta {
            background-color: var(--color-magenta);
            color: white;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .cta-magenta:hover {
            background-color: #C00063; 
            box-shadow: 0 4px 10px rgba(230, 0, 126, 0.4);
        }
        .cta-gold {
            background-color: var(--color-gold);
            color: var(--color-charcoal);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .cta-gold:hover {
            background-color: #C09A34;
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4);
        }
        .nav-link {
            color: var(--color-charcoal);
            border-bottom: 2px solid transparent;
            transition: border-bottom 0.3s;
            font-weight: 600;
        }
        .nav-link:hover, .nav-link.active {
            border-bottom-color: var(--color-magenta);
        }
        .input-style {
            border: 1px solid var(--color-blush-start);
            padding: 10px;
            border-radius: 8px;
            color: var(--color-charcoal);
            transition: border-color 0.3s;
        }
        .input-style:focus {
            outline: none;
            border-color: var(--color-magenta);
            box-shadow: 0 0 0 1px rgba(230, 0, 126, 0.5);
        }
        .section-background {
            background: linear-gradient(135deg, var(--color-blush-start) 0%, var(--color-blush-end) 100%);
            padding: 20px;
            border-radius: 12px;
        }
        .gold-highlight {
            color: var(--color-gold);
            font-weight: 600;
        }
        /* Style for the simulated app content box */
        #app-content-box {
            border: 1px dashed var(--color-magenta);
            padding: 24px;
            border-radius: 12px;
            background-color: #fcf6f9; 
            margin-top: 20px;
        }
        /* Floating Cart Styles */
        .floating-cart {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid var(--color-blush-start);
        }
        
        .floating-cart:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
            border-color: var(--color-magenta);
        }
        
        .cart-icon {
            font-size: 24px;
            color: var(--color-charcoal);
        }
        
        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--color-magenta);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }
        
        /* Cart Modal Styles */
        .cart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }
        
        .cart-modal-content {
            background: white;
            border-radius: 18px;
            padding: 32px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .cart-modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: var(--color-charcoal);
            background: none;
            border: none;
        }
        
        .cart-modal-close:hover {
            color: var(--color-magenta);
        }
    </style>
</head>
<body>
    <!-- Floating Cart -->
    <div id="floating-cart" class="floating-cart">
        <div class="cart-icon">ðŸ›’</div>
        <div id="cart-badge" class="cart-badge" style="display: none;">0</div>
    </div>
    
    <!-- Cart Modal -->
    <div id="cart-modal" class="cart-modal">
        <div class="cart-modal-content">
            <button class="cart-modal-close" onclick="window.app.closeCartModal()">&times;</button>
            
            <h2 class="poetic-title text-3xl mb-4">Your Bloom Cart</h2>
            <div class="text-center italic mb-8">
                <p>"Every flower began as light. Your bloom is ready to take shape."</p>
            </div>
    
            <div id="cart-items-container" class="space-y-4 mb-6">
                <div id="empty-cart-message" class="text-center p-8 border border-gray-200 rounded-lg">
                    Your cart is empty. <a href="#" onclick="window.app.closeCartModal(); window.app.navigateTo('studio')" class="text-magenta font-semibold">Begin the bloom</a>.
                </div>
            </div>
    
            <div class="flex justify-between items-center border-t border-gray-300 pt-4">
                <h3 class="text-xl font-bold">Total: <span id="cart-total-display" class="gold-highlight">$0.00</span></h3>
                <button onclick="window.app.closeCartModal(); window.app.navigateTo('checkout')" id="checkout-button" class="cta-magenta px-6 py-2 rounded-md font-semibold" disabled>
                    Proceed to Checkout
                </button>
            </div>
    
            <div id="promo-section" class="section-background p-4 mt-6">
                <h4 class="font-semibold mb-2">Have a Promo Code?</h4>
                <div class="flex gap-2">
                    <input type="text" id="promo-input" placeholder="Enter code" class="input-style flex-grow">
                    <button onclick="window.app.promoManager.applyPromoCode(document.getElementById('promo-input').value)" class="cta-gold px-4 py-2 rounded-md font-semibold">Apply</button>
                </div>
                <p id="promo-message" class="text-sm mt-2 text-green-700"></p>
            </div>
        </div>
    </div>
    <div class="container">
        <header class="header flex justify-between items-center pb-4 mb-6">
            <img src="logo.png" alt="Bloom" class="h-12 w-auto">
            <div id="auth-action">
                </div>
        </header>

        <div id="nav-container" class="mb-6">
            </div>

        <div id="token-display" class="auth-status text-center mb-4 text-sm">
            </div>

        <main id="app-main-content">
            <section id="homepage" style="display: none;">
                <div class="poetic-title">Your reflection is waiting to bloom.</div>
                <div class="text-center mb-10">
                    <p class="text-xl font-medium text-gray-600 mb-6">"She took a selfie. The flowers took over."</p>
                    <p class="mb-8">Your photo becomes art â€” flowing between your wallpaper and your phone case. Your photo becomes art â€” flowing between your wallpaper and your phone case.</p>
                    <button onclick="window.app.navigateTo('studio')" class="cta-magenta px-8 py-3 text-lg font-semibold rounded-full shadow-lg hover:shadow-xl">Begin the bloom</button>
                </div>
                
                <div class="section-background mt-10 p-8">
                    <h3 class="text-2xl mb-4 font-semibold text-center">Manifesto</h3>
                    <p class="text-center italic mb-2">You are not pixels or paper.</p>
                    <p class="text-center italic mb-2">You are motion and bloom.</p>
                    <p class="text-center italic mb-2">The flowers you wear are grown from your light.</p>
                    <p class="text-center italic mb-4">From your reflection, to your phone, to your hand.</p>
                    <p class="text-center font-bold">This is not a phone case. Itâ€™s a portrait of your bloom.</p>
                </div>
            </section>

            <section id="studio-page" style="display: none;">
                <div id="auth-required-message" class="text-center p-10 bg-red-50 border border-red-300 text-red-700 rounded-lg mb-6">
                    <p class="font-bold text-xl">Access Denied.</p>
                    <p>Please sign in to view and create your bloom.</p>
                </div>

                <div id="app-content-box" style="display: none;">
                    <h2 class="poetic-title text-3xl mb-4">Studio: Capture Your Bloom</h2>
                    <p class="text-center text-lg mb-8">"Your reflection is growing into art."</p>

                    <div class="flex justify-center gap-8 mb-8 text-center text-sm font-medium">
                        <span class="p-2 border-b-2 border-magenta">1. Device & Acknowledge</span>
                        <span class="p-2 border-b-2 border-gray-300">2. Upload Photos</span>
                        <span class="p-2 border-b-2 border-gray-300">3. Preview & Cart</span>
                    </div>

                    <div id="device-selection-step" class="section-background p-6 mb-6">
                        <h3 class="text-xl font-semibold mb-3">1. Select Your Device</h3>
                        <p class="text-sm text-gray-600 mb-4">This device model will be used for final order fulfillment.</p>
                        <div class="flex flex-col sm:flex-row gap-4 mb-4">
                            <select id="device-dropdown" class="input-style flex-grow">
                                <option value="" disabled selected>Choose your phone model...</option>
                                <option value="iphone_15_pro_max">iPhone 15 Pro Max</option>
                                <option value="samsung_s24_ultra">Samsung S24 Ultra</option>
                                <option value="google_pixel_8">Google Pixel 8</option>
                            </select>
                        </div>
                        
                        <div class="flex items-start">
                            <input type="checkbox" id="acknowledgement-box" class="mt-1 mr-2 accent-magenta">
                            <label for="acknowledgement-box" class="text-sm">
                                I acknowledge that the <span class="gold-highlight">initial product mockup</span> may be based on a standard, generic device model for design purposes, regardless of my selection. However, my chosen device (<span id="selected-device-text" class="font-bold italic">None Selected</span>) will be used for the final, physical product.
                            </label>
                        </div>
                        <button id="proceed-upload-button" onclick="window.app.studioManager.checkDeviceAndProceed()" class="cta-magenta mt-4 px-6 py-2 rounded-md font-semibold" disabled>
                            Confirm Selection & Proceed
                        </button>
                    </div>

                    <div id="upload-and-product-step" style="display: none;">
                        <div id="upload-area" class="section-background p-6 mb-6">
                            <h3 class="text-xl font-semibold mb-3">2. Upload Your Reflections (3 Images)</h3>
                            <input type="file" id="photo-upload-1" accept="image/*" class="input-style block w-full mb-2">
                            <input type="file" id="photo-upload-2" accept="image/*" class="input-style block w-full mb-2">
                            <input type="file" id="photo-upload-3" accept="image/*" class="input-style block w-full mb-4">
                            <button onclick="window.app.studioManager.processImages()" class="cta-gold px-6 py-2 rounded-md font-semibold w-full">Watch your reflection grow</button>
                        </div>

                        <div id="processing-progress" class="section-background p-6 mb-6" style="display: none;">
                            <h3 class="text-xl font-semibold mb-3">Processing Your Bloom...</h3>
                            <div class="bg-gray-200 rounded-full h-2.5 mb-2">
                                <div id="progress-bar" class="bg-magenta h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <p id="progress-message" class="text-sm text-gray-600"></p>
                        </div>

                        <div id="product-list-area" style="display: none;">
                            <h3 class="poetic-title text-2xl mt-8 mb-4">3. Your Ready Blooms</h3>
                            <p class="text-center text-sm text-gray-600 mb-6">"This isnâ€™t a case â€” itâ€™s your bloom captured in color."</p>
                            <div id="mockup-products" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="checkout-page" style="display: none;">
                <h2 class="poetic-title text-3xl mb-4">Complete Your Bloom</h2>
                <div class="text-center italic mb-8">
                    <p>"Your reflection is ready to blossom into your hands."</p>
                </div>
            
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Left Column: Forms -->
                    <div class="space-y-6">
                        <!-- Shipping Address -->
                        <div class="section-background p-6">
                            <h3 class="text-xl font-semibold mb-4">Shipping Address</h3>
                            <div class="grid grid-cols-1 gap-4">
                                <input type="text" placeholder="Full Name" class="input-style">
                                <input type="text" placeholder="Street Address" class="input-style">
                                <input type="text" placeholder="Apartment, Suite, etc. (Optional)" class="input-style">
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="text" placeholder="City" class="input-style">
                                    <select class="input-style">
                                        <option value="">State</option>
                                        <option value="CA">California</option>
                                    </select>
                                </div>
                                <input type="text" placeholder="ZIP Code" class="input-style">
                            </div>
                        </div>
            
                        <!-- Billing Address (with same as shipping toggle) -->
                        <div class="section-background p-6">
                            <h3 class="text-xl font-semibold mb-4">Billing Address</h3>
                            <div class="flex items-center mb-4">
                                <input type="checkbox" id="same-as-shipping" class="mr-2 accent-magenta">
                                <label for="same-as-shipping">Same as shipping address</label>
                            </div>
                            <div id="billing-address-fields">
                                <!-- Billing fields would go here -->
                            </div>
                        </div>
            
                        <!-- Payment Method -->
                        <div class="section-background p-6">
                            <h3 class="text-xl font-semibold mb-4">Payment Method</h3>
                            <div class="space-y-4">
                                <div class="border border-gray-300 rounded-lg p-4">
                                    <input type="radio" name="payment" id="credit-card" class="mr-2 accent-magenta" checked>
                                    <label for="credit-card" class="font-semibold">Credit Card</label>
                                    <div class="mt-3 grid grid-cols-1 gap-3">
                                        <input type="text" placeholder="Card Number" class="input-style">
                                        <input type="text" placeholder="Name on Card" class="input-style">
                                        <div class="grid grid-cols-2 gap-3">
                                            <input type="text" placeholder="MM/YY" class="input-style">
                                            <input type="text" placeholder="CVV" class="input-style">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            
                    <!-- Right Column: Order Summary -->
                    <div class="space-y-6">
                        <!-- Order Summary -->
                        <div class="section-background p-6">
                            <h3 class="text-xl font-semibold mb-4">Order Summary</h3>
                            <div id="checkout-items" class="space-y-3 mb-4">
                                <!-- Cart items will be populated here -->
                            </div>
                            <div class="border-t pt-4 space-y-2">
                                <div class="flex justify-between">
                                    <span>Subtotal</span>
                                    <span id="checkout-subtotal">$0.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Shipping</span>
                                    <span id="checkout-shipping">$5.99</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Tax</span>
                                    <span id="checkout-tax">$0.00</span>
                                </div>
                                <div class="flex justify-between font-bold text-lg border-t pt-2">
                                    <span>Total</span>
                                    <span id="checkout-total">$0.00</span>
                                </div>
                            </div>
                        </div>
            
                        <!-- Promo Code -->
                        <div class="section-background p-6">
                            <h4 class="font-semibold mb-3">Promo Code</h4>
                            <div class="flex gap-2">
                                <input type="text" id="checkout-promo-input" placeholder="Enter code" class="input-style flex-grow">
                                <button onclick="window.app.promoManager.applyPromoCode(document.getElementById('checkout-promo-input').value)" class="cta-gold px-4 py-2 rounded-md font-semibold">Apply</button>
                            </div>
                            <p id="checkout-promo-message" class="text-sm mt-2 text-green-700"></p>
                        </div>
            
                        <!-- Place Order Button -->
                        <button onclick="window.app.checkoutManager.placeOrder()" class="cta-magenta w-full py-4 text-lg font-semibold rounded-lg shadow-lg hover:shadow-xl">
                            Place Your Order
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- PKCE UTILITY FUNCTIONS (Unchanged, for brevity) ---
        function base64urlencode(buffer){
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }
        async function sha256(str){
            const digest = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
            return base64urlencode(digest);
        }
        function genRandom(){ 
            const arr = new Uint8Array(32); 
            crypto.getRandomValues(arr); 
            return base64urlencode(arr); 
        }

        // --- CONFIG & SESSION MANAGEMENT (Unchanged, for brevity) ---
        const cognitoConfig = {
            clientId: '73lf1h32phkqeb9ahu6tqcl9av',
            domain: 'auth.theweer.com',
            redirectUri: window.location.origin + window.location.pathname,
            tokenEndpoint: `https://auth.theweer.com/oauth2/token`
        };

        function saveSession(t){ localStorage.setItem('cognitoSession', JSON.stringify(t)); }
        function getSession(){
            const session = localStorage.getItem('cognitoSession');
            return session ? JSON.parse(session) : null;
        }
        function clearUserData() {
            localStorage.removeItem('activePromoDiscount');
            localStorage.removeItem('userUploads');
            localStorage.removeItem('deviceSelection');
            localStorage.removeItem('shoppingCart');
            localStorage.removeItem('currentProductDesigns'); // Added for the new flow
            console.log('All user-specific data cleared');
        }
        function clearSession() {
            localStorage.removeItem('cognitoSession');
            localStorage.removeItem('pkce_verifier');
            clearUserData();
        }

        function isTokenExpired(token) {
            if (!token) return true;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const exp = payload.exp * 1000;
                const now = Date.now();
                const bufferTime = 300000; // 5-minute buffer
                return now >= (exp - bufferTime);
            } catch (e) {
                console.error('Error checking token expiration:', e);
                return true;
            }
        }
        
        async function refreshSession() {
            const session = getSession();
            if (!session || !session.refresh_token) {
                clearSession();
                return false;
            }
            console.log('Attempting silent token refresh...');
            const body =
              `grant_type=refresh_token`
              + `&client_id=${cognitoConfig.clientId}`
              + `&refresh_token=${session.refresh_token}`;

            try {
                const res = await fetch(cognitoConfig.tokenEndpoint,{
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body
                });
                const tokens = await res.json();

                if(res.ok && tokens.id_token) {
                    const newSession = {
                        ...tokens,
                        refresh_token: tokens.refresh_token || session.refresh_token 
                    };
                    saveSession(newSession);
                    console.log('Token refresh successful! Session extended.');
                    return true;
                } else {
                    console.error("Refresh token exchange failed. Logging out:", tokens.error_description || JSON.stringify(tokens));
                    clearSession();
                    return false;
                }
            } catch (error) {
                console.error('Network or exchange error during refresh:', error);
                return false;
            }
        }

        async function isAuthenticated() {
            const session = getSession();
            if (!session || !session.id_token) return false;

            if (isTokenExpired(session.id_token)) {
                console.log('ID Token expired/expiring. Attempting refresh...');
                const refreshed = await refreshSession();
                return refreshed;
            }
            return true;
        }

        function getUserInfo() {
            const session = getSession();
            if (session && session.id_token) {
                try {
                    const payload = JSON.parse(atob(session.id_token.split('.')[1]));
                    const displayName = payload.name || payload.given_name || payload.email || payload.sub;
                    return { email: payload.email, sub: payload.sub, displayName: displayName };
                } catch (e) {
                    console.error('Error parsing token:', e);
                }
            }
            return null;
        }

        // --- AUTH FLOW FUNCTIONS (PKCE) (Unchanged, for brevity) ---
        async function signin(){
            const verifier = genRandom();
            localStorage.setItem('pkce_verifier', verifier);
            const challenge = await sha256(verifier);
            
            const url = `https://${cognitoConfig.domain}/oauth2/authorize?response_type=code`
              + `&client_id=${cognitoConfig.clientId}`
              + `&redirect_uri=${encodeURIComponent(cognitoConfig.redirectUri)}`
              + `&scope=email+openid+profile` 
              + `&code_challenge_method=S256`
              + `&code_challenge=${challenge}`;
              
            window.location.href = url;
        }

        function signout(){
            clearSession();
            window.location.href = `https://${cognitoConfig.domain}/logout?client_id=${cognitoConfig.clientId}`
              + `&logout_uri=${encodeURIComponent(window.location.origin)}`;
        }

        async function handleCodeExchange(){
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            if(!code) return false;

            const verifier = localStorage.getItem('pkce_verifier');
            if (!verifier) {
                console.error("PKCE Error: Code verifier not found in storage.");
                window.history.replaceState({},document.title,cognitoConfig.redirectUri); 
                return false;
            }

            const body =
              `grant_type=authorization_code`
              + `&client_id=${cognitoConfig.clientId}`
              + `&code=${code}`
              + `&redirect_uri=${encodeURIComponent(cognitoConfig.redirectUri)}`
              + `&code_verifier=${verifier}`;

            try {
                const res = await fetch(cognitoConfig.tokenEndpoint,{
                    method:'POST',
                    headers:{'Content-Type':'application/x-www-form-urlencoded'},
                    body
                });
                const tokens = await res.json();

                if(res.ok && tokens.id_token) {
                    saveSession(tokens);
                    localStorage.removeItem('pkce_verifier');
                    window.history.replaceState({},document.title,cognitoConfig.redirectUri);
                    return true;
                } else {
                    console.error("Token exchange failed:", tokens.error_description || JSON.stringify(tokens));
                    return false;
                }
            } catch (error) {
                console.error('Network or exchange error:', error);
                return false;
            }
        }

        // --- UI MANAGEMENT (Slightly modified to use the new navigation) ---
        function renderAuthUI() {
            const authDiv = document.getElementById('auth-action');
            if (!authDiv) return;
            
            const userInfo = getUserInfo();
            
            if (userInfo) {
                authDiv.innerHTML = `
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-medium">Welcome, ${userInfo.displayName}</span>
                        <button onclick="window.app.signout()" class="px-3 py-1 bg-red-500 text-white text-sm rounded-full shadow-md hover:bg-red-600">Sign Out</button>
                    </div>
                `;
            } else {
                authDiv.innerHTML = `
                    <button onclick="window.app.signin()" class="cta-gold px-4 py-2 text-sm font-semibold rounded-full shadow-lg">Sign In / Sign Up</button>
                `;
            }
        }

        function renderNavigation(currentPage) {
            const navContainer = document.getElementById('nav-container');
            if (!navContainer) return;
            
            const links = [
                { id: 'home', label: 'Home', target: 'home' },
                { id: 'studio', label: 'Studio', target: 'studio' },
                { id: 'checkout', label: 'Checkout', target: 'checkout' }
            ];
            
            let navHTML = '<nav class="flex flex-wrap justify-center gap-4 sm:gap-6 py-2">';
            links.forEach(link => {
                const activeClass = currentPage === link.target ? 'active border-b-2 border-magenta font-bold' : '';
                navHTML += `<a href="#" onclick="window.app.navigateTo('${link.target}')" class="nav-link ${activeClass} px-3 py-2 text-sm sm:text-base transition-colors duration-200">${link.label}</a>`;
            });
            navHTML += '</nav>';
            navContainer.innerHTML = navHTML;
        }

        function checkAuthAndUpdateUI() {
            // Re-renders the UI based on the current session state
            const userInfo = getUserInfo();
            
            const appContentBox = document.getElementById('app-content-box');
            const authRequired = document.getElementById('auth-required-message');
            
            if (appContentBox && authRequired) {
                if (userInfo) {
                    appContentBox.style.display = 'block';
                    authRequired.style.display = 'none';
                } else {
                    appContentBox.style.display = 'none';
                    authRequired.style.display = 'block';
                }
            }
            
            renderAuthUI();
            window.app.showSessionInfo(); // Update session display
        }

        function setupTokenRefresh() {
            setInterval(async () => {
                const session = getSession();
                if (session && isTokenExpired(session.id_token)) {
                    console.log('Scheduled check: ID Token is expired or expiring. Triggering refresh...');
                    await refreshSession();
                    checkAuthAndUpdateUI();
                }
            }, 30000); // Check every 30 seconds
        }

        async function initializeAuth() {
            await handleCodeExchange();
            
            // This call to isAuthenticated() will automatically trigger a refresh 
            const actualAuthStatus = await isAuthenticated();
            
            checkAuthAndUpdateUI(); 
            
            renderAuthUI();
            
            setupTokenRefresh();
            
            return actualAuthStatus;
        }
        
        window.signin = signin;
        window.signout = signout;
        window.getSession = getSession;
        window.isAuthenticated = isAuthenticated;
        window.getUserInfo = getUserInfo;


        // --- APPLICATION LOGIC (Modularized for E-commerce) ---

        /** * 1. CartManager: Handles all cart state and calculation.
         */
        class CartManager {
            constructor() {
                this.cartKey = 'shoppingCart';
                this.promoDiscount = 0;
            }

            updateCartBadge() {
                const cart = this.getCart();
                const badge = document.getElementById('cart-badge');
                const count = cart.length;
                
                if (count > 0) {
                    badge.style.display = 'flex';
                    badge.textContent = count > 9 ? '9+' : count.toString();
                } else {
                    badge.style.display = 'none';
                }
            }

            addToCart(product) {
                let cart = this.getCart();
                const exists = cart.some(item => item.designId === product.designId);
                
                if (exists) {
                    console.warn(`Product with designId ${product.designId} already in cart.`);
                    return false;
                }
            
                cart.push({
                    designId: product.designId,
                    name: product.name,
                    price: product.price,
                    images: product.images,
                    device: product.device
                });
                this.saveCart(cart);
                this.updateCartBadge(); // Add this line
                window.app.renderCurrentPage();
                console.log(`Added ${product.name} to cart.`);
                return true;
            }
            
            removeFromCart(designId) {
                let cart = this.getCart();
                cart = cart.filter(item => item.designId !== designId);
                this.saveCart(cart);
                this.updateCartBadge(); // Add this line
                window.app.renderCurrentPage();
                console.log(`Removed designId ${designId} from cart.`);
            }
            
            getCart() {
                const cart = localStorage.getItem(this.cartKey);
                return cart ? JSON.parse(cart) : [];
            }

            saveCart(cart) {
                localStorage.setItem(this.cartKey, JSON.stringify(cart));
            }

            getCartTotal() {
                const cart = this.getCart();
                const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
                // Simple discount calculation
                const finalTotal = subtotal * (1 - this.promoDiscount);
                return {
                    subtotal: subtotal.toFixed(2),
                    discount: (subtotal * this.promoDiscount).toFixed(2),
                    total: finalTotal.toFixed(2)
                };
            }

            /**
             * Adds a unique product design to the cart.
             * A unique product can only be in the cart once.
             */
            addToCart(product) {
                let cart = this.getCart();
                const exists = cart.some(item => item.designId === product.designId);
                
                if (exists) {
                    console.warn(`Product with designId ${product.designId} already in cart.`);
                    return false;
                }

                cart.push({
                    designId: product.designId,
                    name: product.name,
                    price: product.price,
                    images: product.images,
                    device: product.device // The selected device model
                });
                this.saveCart(cart);
                window.app.renderCurrentPage(); // Re-render Cart/Studio for button updates
                console.log(`Added ${product.name} to cart.`);
                return true;
            }

            removeFromCart(designId) {
                let cart = this.getCart();
                cart = cart.filter(item => item.designId !== designId);
                this.saveCart(cart);
                window.app.renderCurrentPage(); // Re-render Cart/Studio for button updates
                console.log(`Removed designId ${designId} from cart.`);
            }
        }
        
        /**
         * 2. PromoManager: Manages promotional codes.
         */
        class PromoManager {
            constructor(cartManager) {
                this.cartManager = cartManager;
                this.validCodes = {
                    "BLOOM20": 0.20, // 20% off
                    "FREESHIP": 0 // Placeholder for free shipping logic
                };
            }

            applyPromoCode(code) {
                const normalizedCode = code.toUpperCase().trim();
                const discountRate = this.validCodes[normalizedCode];

                if (discountRate !== undefined) {
                    this.cartManager.promoDiscount = discountRate;
                    document.getElementById('promo-message').innerText = `Success! ${normalizedCode} applied. ${discountRate * 100}% discount active.`;
                } else {
                    this.cartManager.promoDiscount = 0;
                    document.getElementById('promo-message').innerText = `Error: Code '${code}' is invalid or expired.`;
                    document.getElementById('promo-message').classList.remove('text-green-700');
                    document.getElementById('promo-message').classList.add('text-red-700');
                }
                window.app.renderCurrentPage(); // Update total in cart
            }

            clearPromoData() {
                this.cartManager.promoDiscount = 0;
            }
        }

        /**
         * 3. StudioManager: Handles the product configuration flow.
         */
        class StudioManager {
            constructor(cartManager) {
                this.cartManager = cartManager;
                this.mockDesigns = [
                    { designId: 'design_a', name: 'Coral Bloom Case', price: 49.99, images: ['mockup_a_1.jpg', 'mockup_a_2.jpg', 'mockup_a_3.jpg', 'mockup_a_4.jpg'] },
                    { designId: 'design_b', name: 'Midnight Petal Case', price: 54.99, images: ['mockup_b_1.jpg', 'mockup_b_2.jpg', 'mockup_b_3.jpg', 'mockup_b_4.jpg'] }
                ];
                // Event listener for device selection change
                document.getElementById('device-dropdown').addEventListener('change', this.updateDeviceDisplay.bind(this));
                document.getElementById('acknowledgement-box').addEventListener('change', this.updateDeviceDisplay.bind(this));
            }

            updateDeviceDisplay() {
                const dropdown = document.getElementById('device-dropdown');
                const ackBox = document.getElementById('acknowledgement-box');
                const proceedButton = document.getElementById('proceed-upload-button');
                const selectedText = dropdown.options[dropdown.selectedIndex].text;

                document.getElementById('selected-device-text').innerText = selectedText === 'Choose your phone model...' ? 'None Selected' : selectedText;
                
                // Enable button only if a device is selected AND the box is checked
                proceedButton.disabled = dropdown.value === '' || !ackBox.checked;
            }

            checkDeviceAndProceed() {
                const device = document.getElementById('device-dropdown').value;
                const acknowledged = document.getElementById('acknowledgement-box').checked;

                if (device && acknowledged) {
                    localStorage.setItem('deviceSelection', device);
                    document.getElementById('device-selection-step').style.display = 'none';
                    document.getElementById('upload-and-product-step').style.display = 'block';
                    // Update steps UI
                    document.querySelector('#studio-page .flex span:nth-child(1)').classList.remove('border-magenta');
                    document.querySelector('#studio-page .flex span:nth-child(1)').classList.add('border-gray-300');
                    document.querySelector('#studio-page .flex span:nth-child(2)').classList.add('border-magenta');
                } else {
                    alert('Please select a device and acknowledge the statement to proceed.');
                }
            }

            /**
             * Simulates the server-side process of creating product mockups.
             */
            processImages() {
                // Check if files are selected
                const files = [
                    document.getElementById('photo-upload-1').files[0],
                    document.getElementById('photo-upload-2').files[0],
                    document.getElementById('photo-upload-3').files[0]
                ];

                if (files.some(f => !f)) {
                    alert('Please upload exactly 3 photos.');
                    return;
                }

                document.getElementById('upload-area').style.display = 'none';
                document.getElementById('processing-progress').style.display = 'block';
                document.getElementById('progress-bar').style.width = '0%';
                document.getElementById('progress-message').innerText = 'Starting image analysis...';

                // Simulate progress
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 10;
                    document.getElementById('progress-bar').style.width = progress + '%';

                    if (progress === 30) {
                        document.getElementById('progress-message').innerText = 'Generating flower collage composition...';
                    } else if (progress === 60) {
                        document.getElementById('progress-message').innerText = 'Rendering 3D product mockups...';
                    } else if (progress >= 100) {
                        clearInterval(interval);
                        document.getElementById('processing-progress').style.display = 'none';
                        this.finishProcessing();
                    }
                }, 500);
            }
            
            finishProcessing() {
                localStorage.setItem('currentProductDesigns', JSON.stringify(this.mockDesigns));
                document.getElementById('product-list-area').style.display = 'block';
                // Update steps UI
                document.querySelector('#studio-page .flex span:nth-child(2)').classList.remove('border-magenta');
                document.querySelector('#studio-page .flex span:nth-child(2)').classList.add('border-gray-300');
                document.querySelector('#studio-page .flex span:nth-child(3)').classList.add('border-magenta');

                this.renderProductList();
            }

            renderProductList() {
                const productListDiv = document.getElementById('mockup-products');
                const designs = JSON.parse(localStorage.getItem('currentProductDesigns') || '[]');
                const cart = this.cartManager.getCart();
                const selectedDevice = localStorage.getItem('deviceSelection') || 'Not Set';
                
                if (designs.length === 0) {
                    productListDiv.innerHTML = '<p class="text-center">No blooms generated yet.</p>';
                    return;
                }

                productListDiv.innerHTML = designs.map(product => {
                    const isInCart = cart.some(item => item.designId === product.designId);
                    const buttonText = isInCart ? 'In Cart (Remove)' : 'Add to Cart';
                    const buttonClass = isInCart ? 'bg-red-500 hover:bg-red-600' : 'cta-magenta';

                    return `
                        <div class="p-4 border border-gray-200 rounded-lg shadow-sm">
                            <h4 class="text-xl font-semibold mb-2">${product.name}</h4>
                            <p class="text-sm text-gray-600 mb-2">For: <span class="font-medium">${selectedDevice}</span></p>
                            <div class="bg-gray-100 h-40 flex items-center justify-center mb-3 rounded-md">
                                
                            </div>
                            <p class="font-bold text-lg mb-3 gold-highlight">$${product.price.toFixed(2)}</p>
                            <button onclick="window.app.studioManager.handleCartAction('${product.designId}')" 
                                class="w-full px-4 py-2 text-white font-semibold rounded-md ${buttonClass}">
                                ${buttonText}
                            </button>
                            <p class="text-xs text-gray-500 mt-2 text-center">See all 4 images on Cart page.</p>
                        </div>
                    `;
                }).join('');
            }
            
            handleCartAction(designId) {
                const cart = this.cartManager.getCart();
                const isInCart = cart.some(item => item.designId === designId);
                const designs = JSON.parse(localStorage.getItem('currentProductDesigns') || '[]');
                const product = designs.find(d => d.designId === designId);
                const device = localStorage.getItem('deviceSelection');

                if (!product || !device) return;

                if (isInCart) {
                    this.cartManager.removeFromCart(designId);
                } else {
                    this.cartManager.addToCart({ ...product, device });
                }
            }
        }

        /**
         * 4. Application: The main orchestrator and router.
         */
        class Application {
            constructor() {
                this.cartManager = new CartManager();
                this.promoManager = new PromoManager(this.cartManager);
                this.studioManager = new StudioManager(this.cartManager);
                this.currentPage = 'home';
            }

            async initialize() {
                // Set up global references
                window.app = this;
                
                const isAuthenticatedStatus = await initializeAuth(); 
                
                // Initialize cart badge
                this.cartManager.updateCartBadge();
                
                // Add floating cart click event
                document.getElementById('floating-cart').addEventListener('click', () => {
                    this.openCartModal();
                });
                document.getElementById('cart-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'cart-modal') {
                        this.closeCartModal();
                    }
                });
                this.renderCurrentPage();
            }

            openCartModal() {
                this.renderCart();
                document.getElementById('cart-modal').style.display = 'flex';
            }
            
            closeCartModal() {
                document.getElementById('cart-modal').style.display = 'none';
            }
            
            // In the Application class, add:
            renderCheckout() {
                // This will be implemented when we build the full checkout functionality
                console.log("Checkout page rendered");
            }
            navigateTo(page) {
                if (page === 'cart') {
                    this.openCartModal(); // Open modal instead of navigating to cart page
                } else {
                    this.currentPage = page;
                    this.renderCurrentPage();
                }
            }

            renderCurrentPage() {
                // Hide all main sections first
                const sections = ['homepage', 'studio-page', 'checkout-page'];
                sections.forEach(section => {
                    const element = document.getElementById(section);
                    if (element) {
                        element.style.display = 'none';
                    }
                });
                
                // Show the current page (only if it's not cart, since cart is now a modal)
                if (this.currentPage !== 'cart') {
                    const targetElement = document.getElementById(`${this.currentPage}-page`) || document.getElementById(this.currentPage);
                    if (targetElement) {
                        targetElement.style.display = 'block';
                    }
                }
            
                // Call page-specific render functions
                if (this.currentPage === 'studio') {
                    // Check auth again and update UI of studio page specifically
                    const isAuth = !!getUserInfo();
                    checkAuthAndUpdateUI(); // Updates the auth-required message visibility
                    if (isAuth) {
                        this.studioManager.renderProductList(); // Re-render product list to update cart button states
                    }
                } else if (this.currentPage === 'checkout') {
                    this.renderCheckout();
                }
            
                renderNavigation(this.currentPage); // Update navigation highlights
                this.showSessionInfo();
            }

            renderCart() {
                const cart = this.cartManager.getCart();
                const container = document.getElementById('cart-items-container');
                const totals = this.cartManager.getCartTotal();
                
                document.getElementById('cart-total-display').innerText = `$${totals.total}`;
                document.getElementById('checkout-button').disabled = cart.length === 0;
            
                if (cart.length === 0) {
                    container.innerHTML = `<div id="empty-cart-message" class="text-center p-8 border border-gray-200 rounded-lg">
                        Your cart is empty. <a href="#" onclick="window.app.closeCartModal(); window.app.navigateTo('studio')" class="text-magenta font-semibold">Begin the bloom</a>.
                    </div>`;
                    return;
                }
            
                container.innerHTML = cart.map(item => `
                    <div class="flex items-center p-4 border border-gray-100 rounded-lg shadow-sm">
                        <div class="w-16 h-16 bg-gray-100 mr-4 flex-shrink-0 rounded-md flex items-center justify-center">
                            <span class="text-gray-400 text-xs">${item.name}</span>
                        </div>
                        <div class="flex-grow">
                            <h4 class="font-semibold">${item.name}</h4>
                            <p class="text-sm text-gray-500">Device: ${item.device}</p>
                            <p class="text-sm gold-highlight">$${item.price.toFixed(2)}</p>
                        </div>
                        <button onclick="window.app.cartManager.removeFromCart('${item.designId}')" class="text-sm text-red-500 hover:text-red-700 ml-4">
                            Remove
                        </button>
                    </div>
                `).join('');
                
                container.innerHTML += `
                    <div class="text-right pt-4 border-t border-gray-200">
                        <p class="mb-1">Subtotal: $${totals.subtotal}</p>
                        ${this.cartManager.promoDiscount > 0 ? `<p class="text-green-600 mb-1">Discount: -$${totals.discount}</p>` : ''}
                        <p class="font-bold text-lg">Total: $${totals.total}</p>
                    </div>
                `;
                
                document.getElementById('promo-message').innerText = this.cartManager.promoDiscount > 0 
                    ? `Active Discount: ${this.cartManager.promoDiscount * 100}%` 
                    : '';
            }

            // Simulators for feature interaction
            applyPromoCode() { /* Handled by PromoManager */ }
            uploadFiles() { console.log("Upload flow started/resumed."); }

            showSessionInfo() {
                const userInfo = getUserInfo();
                const tokenDiv = document.getElementById('token-display');
                
                if (userInfo) {
                    tokenDiv.innerHTML = `<span class="text-green-700 font-medium">Signed in as ${userInfo.displayName}</span>`;
                } else {
                    tokenDiv.innerHTML = `<span class="text-red-500 font-medium">Not signed in</span>`;
                }
            }
            
            signin() { signin(); }
            signout() { signout(); }
        }

        // Initialize application when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            window.app = new Application();
            await window.app.initialize();
        });
    </script>
    <footer class="w-full max-w-960px mt-12 py-8 border-t border-gray-200">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Company Info -->
                <div>
                    <h3 class="font-bold text-lg mb-4">GOLDEN GATE BLOOMS LLC</h3>
                    <address class="not-italic text-sm text-gray-600">
                        <p>3400 COTTAGE WAY</p>
                        <p>STE G2</p>
                        <p>SACRAMENTO, CA 95825</p>
                    </address>
                </div>
                
                <!-- Legal Links -->
                <div>
                    <h3 class="font-bold text-lg mb-4">Legal</h3>
                    <div class="space-y-2">
                        <a href="/privacy-policy" class="block text-sm text-gray-600 hover:text-magenta transition-colors">Privacy Policy</a>
                        <a href="/terms-of-service" class="block text-sm text-gray-600 hover:text-magenta transition-colors">Terms of Service</a>
                    </div>
                </div>
                
                <!-- Contact -->
                <div>
                    <h3 class="font-bold text-lg mb-4">Contact</h3>
                    <p class="text-sm text-gray-600">Need help with your order?</p>
                    <a href="mailto:support@goldengateblooms.com" class="text-sm text-magenta hover:underline">support@goldengateblooms.com</a>
                </div>
            </div>
            
            <div class="border-t border-gray-200 mt-8 pt-6 text-center">
                <p class="text-sm text-gray-500">&copy; 2024 Golden Gate Blooms LLC. All rights reserved.</p>
            </div>
        </div>
    </footer>
</body>
</html>
