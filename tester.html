<!DOCTYPE html>
<html>
<head>
    <title>API Test - The Weer</title>
    <style>
        body { font-family: Arial; margin: 40px; }
        button { 
            padding: 15px 30px; 
            font-size: 18px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #result { margin-top: 20px; padding: 10px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>API Gateway Test</h1>
    <div id="auth-status">
        <p>Checking authentication...</p>
    </div>
    <button onclick="callApi()" id="apiButton" disabled>Test API Call</button>
    <div id="result"></div>

    <script>
        const API_URL = 'https://rd8hnh5ch6.execute-api.us-east-1.amazonaws.com/prod/add-record';
        const COGNITO_CONFIG = {
            clientId: '7irso7dmmnp793egs9bhkl0t81',
            domain: 'auth.theweer.com'
        };

        // Check if we have a token in the URL (implicit flow callback)
        function checkForTokenInURL() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            
            const accessToken = params.get('access_token');
            const idToken = params.get('id_token');
            
            if (idToken) {
                // Store the token
                localStorage.setItem('apiTestToken', idToken);
                // Clear the URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                document.getElementById('auth-status').innerHTML = 
                    '<div class="success">✅ Got authentication token! Ready to test API.</div>';
                document.getElementById('apiButton').disabled = false;
                
                return idToken;
            }
            return null;
        }

        // Check if we have a stored token
        function checkStoredToken() {
            const token = localStorage.getItem('apiTestToken');
            if (token) {
                document.getElementById('auth-status').innerHTML = 
                    '<div class="success">✅ Using stored authentication token.</div>';
                document.getElementById('apiButton').disabled = false;
                return token;
            }
            return null;
        }

        // Get authentication token
        function getAuthToken() {
            // First check URL (for callback)
            const urlToken = checkForTokenInURL();
            if (urlToken) return urlToken;
            
            // Then check stored token
            const storedToken = checkStoredToken();
            if (storedToken) return storedToken;
            
            // No token found
            document.getElementById('auth-status').innerHTML = `
                <div class="error">
                    ❌ Not authenticated for API testing
                    <br><br>
                    <button onclick="authenticateForAPI()" class="btn-primary">Authenticate for API Test</button>
                    <br><br>
                    <small>This uses a different authentication flow specifically for API testing</small>
                </div>
            `;
            return null;
        }

        // Authenticate specifically for API testing
        function authenticateForAPI() {
            const redirectUri = encodeURIComponent(window.location.href);
            const authUrl = `https://${COGNITO_CONFIG.domain}/oauth2/authorize?` +
                `client_id=${COGNITO_CONFIG.clientId}` +
                `&response_type=token` +
                `&scope=email+openid` +
                `&redirect_uri=${redirectUri}` +
                `&state=api_test`;
            
            window.location.href = authUrl;
        }

        // Clear authentication
        function clearAuth() {
            localStorage.removeItem('apiTestToken');
            document.getElementById('auth-status').innerHTML = 
                '<div class="info">Authentication cleared. Refresh to re-authenticate.</div>';
            document.getElementById('apiButton').disabled = true;
            document.getElementById('result').innerHTML = '';
        }

        // Main API call function
        async function callApi() {
            const button = document.getElementById('apiButton');
            const resultDiv = document.getElementById('result');
            
            button.disabled = true;
            button.textContent = 'Calling API...';
            resultDiv.innerHTML = '';

            try {
                const token = localStorage.getItem('apiTestToken');
                if (!token) {
                    throw new Error('No authentication token found');
                }

                console.log('Calling API with token...');
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            ✅ Success! API call completed.
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.message || `API returned ${response.status}`);
                }

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        ❌ API Call Failed: ${error.message}
                        <br><br>
                        <button onclick="clearAuth()">Clear Authentication & Retry</button>
                    </div>
                `;
                console.error('API call failed:', error);
            } finally {
                button.disabled = false;
                button.textContent = 'Test API Call';
            }
        }

        // Initialize
        window.addEventListener('load', function() {
            const token = getAuthToken();
            if (token) {
                // Add a clear button
                document.getElementById('auth-status').innerHTML += 
                    '<br><button onclick="clearAuth()" style="background: #dc2626;">Clear Auth</button>';
            }
        });
    </script>
</body>
</html>
