<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cognito Auth Troubleshooter</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
.container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
h1,h2,h3 { color:#333; }
.test-section { background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 5px; border-left: 4px solid #007bff; }
.test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
.success { background: #d4edda; border: 1px solid #c3e6cb; }
.error { background: #f8d7da; border: 1px solid #f5c6cb; }
.warning { background: #fff3cd; border: 1px solid #ffeaa7; }
button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 4px; overflow-x: auto; }
</style>
</head>
<body>

<div class="container">
    <h1>üîß Cognito Domain Troubleshooter</h1>
    <p>Testing: <code>auth.theweer.com</code></p>

    <div class="test-section">
        <h3>1. DNS Resolution Test</h3>
        <button onclick="testDNS()">Test DNS</button>
        <div id="dns-result"></div>
    </div>

    <div class="test-section">
        <h3>2. SSL Certificate Test</h3>
        <button onclick="testSSL()">Test SSL</button>
        <div id="ssl-result"></div>
    </div>

    <div class="test-section">
        <h3>3. Cognito Endpoint Tests</h3>
        <button onclick="testEndpoints()">Test All Endpoints</button>
        <div id="endpoints-result"></div>
    </div>

    <div class="test-section">
        <h3>4. Direct Authentication Test</h3>
        <button onclick="testAuthentication()">Test Auth Flow</button>
        <div id="auth-result"></div>
    </div>

    <div class="test-section">
        <h3>5. Alternative Solutions</h3>
        <div id="solutions">
            <p><strong>If custom domain continues to fail:</strong></p>
            <button onclick="useCognitoDomain()">Use Default Cognito Domain</button>
            <button onclick="showManualConfig()">Manual Configuration</button>
        </div>
    </div>
</div>

<script>
// Test DNS resolution
async function testDNS() {
    const resultDiv = document.getElementById('dns-result');
    resultDiv.innerHTML = '<div class="test-result warning">Testing DNS resolution...</div>';
    
    try {
        // Try to fetch and see if DNS resolves
        const response = await fetch('https://auth.theweer.com/', { 
            method: 'HEAD',
            mode: 'no-cors'
        });
        resultDiv.innerHTML = '<div class="test-result success">‚úÖ DNS resolves successfully</div>';
    } catch (error) {
        resultDiv.innerHTML = `
            <div class="test-result error">
                ‚ùå DNS resolution failed: ${error.message}
                <p><strong>Solution:</strong> Check your Route53 DNS configuration. The CNAME record for auth.theweer.com should point to your Cognito domain.</p>
            </div>
        `;
    }
}

// Test SSL certificate
async function testSSL() {
    const resultDiv = document.getElementById('ssl-result');
    resultDiv.innerHTML = '<div class="test-result warning">Testing SSL certificate...</div>';
    
    try {
        const response = await fetch('https://auth.theweer.com/');
        const certValid = response.status !== 525; // 525 = SSL Handshake Failed
        
        if (certValid) {
            resultDiv.innerHTML = '<div class="test-result success">‚úÖ SSL certificate is valid</div>';
        } else {
            resultDiv.innerHTML = '<div class="test-result error">‚ùå SSL certificate issue detected</div>';
        }
    } catch (error) {
        if (error.message.includes('certificate') || error.message.includes('SSL')) {
            resultDiv.innerHTML = `
                <div class="test-result error">
                    ‚ùå SSL Certificate Error: ${error.message}
                    <p><strong>Solution:</strong> Check ACM certificate for auth.theweer.com in us-east-1 region</p>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `<div class="test-result warning">‚ö†Ô∏è Could not verify SSL: ${error.message}</div>`;
        }
    }
}

// Test all Cognito endpoints
async function testEndpoints() {
    const resultDiv = document.getElementById('endpoints-result');
    resultDiv.innerHTML = '<div class="test-result warning">Testing Cognito endpoints...</div>';
    
    const endpoints = [
        { path: '/.well-known/openid-configuration', name: 'OpenID Config' },
        { path: '/.well-known/oauth-authorization-server', name: 'OAuth2 Config' },
        { path: '/oauth2/authorize', name: 'OAuth2 Authorize' },
        { path: '/login', name: 'Login UI' },
        { path: '/oauth2/token', name: 'Token Endpoint' }
    ];
    
    let results = [];
    
    for (const endpoint of endpoints) {
        const url = `https://auth.theweer.com${endpoint.path}`;
        try {
            const response = await fetch(url, { method: 'HEAD' });
            results.push({
                name: endpoint.name,
                url: url,
                status: response.status,
                statusText: response.statusText,
                success: response.ok
            });
        } catch (error) {
            results.push({
                name: endpoint.name,
                url: url,
                status: 'Error',
                statusText: error.message,
                success: false
            });
        }
    }
    
    let resultsHTML = '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
    resultsHTML += '<tr><th style="text-align: left; padding: 8px; border-bottom: 1px solid #ccc;">Endpoint</th><th style="text-align: left; padding: 8px; border-bottom: 1px solid #ccc;">Status</th></tr>';
    
    results.forEach(result => {
        const statusClass = result.success ? 'success' : (result.status === 403 ? 'warning' : 'error');
        const statusIcon = result.success ? '‚úÖ' : (result.status === 403 ? '‚ö†Ô∏è' : '‚ùå');
        
        resultsHTML += `
            <tr>
                <td style="padding: 8px; border-bottom: 1px solid #eee;"><strong>${result.name}</strong><br><small>${result.url}</small></td>
                <td style="padding: 8px; border-bottom: 1px solid #eee;" class="${statusClass}">
                    ${statusIcon} ${result.status} - ${result.statusText}
                </td>
            </tr>
        `;
    });
    
    resultsHTML += '</table>';
    resultDiv.innerHTML = resultsHTML;
}

// Test authentication flow
async function testAuthentication() {
    const resultDiv = document.getElementById('auth-result');
    resultDiv.innerHTML = '<div class="test-result warning">Testing authentication flow...</div>';
    
    const verifier = genRandom();
    localStorage.setItem('pkce_verifier', verifier);
    const challenge = await sha256(verifier);
    
    const authUrl = new URL('https://auth.theweer.com/oauth2/authorize');
    authUrl.searchParams.append('response_type', 'code');
    authUrl.searchParams.append('client_id', '73lf1h32phkqeb9ahu6tqcl9av');
    authUrl.searchParams.append('redirect_uri', 'https://theweer.com/tester.html');
    authUrl.searchParams.append('scope', 'email openid profile');
    authUrl.searchParams.append('code_challenge_method', 'S256');
    authUrl.searchParams.append('code_challenge', challenge);
    
    resultDiv.innerHTML = `
        <div class="test-result warning">
            üîÑ Attempting authentication...
            <p><strong>Auth URL:</strong> <code>${authUrl.toString().substring(0, 100)}...</code></p>
            <button onclick="window.location.href = '${authUrl.toString()}'">Open Auth Page</button>
        </div>
    `;
}

// PKCE helpers
function base64urlencode(str){
    return btoa(String.fromCharCode.apply(null, new Uint8Array(str)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

async function sha256(buffer){
    const digest = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(buffer));
    return base64urlencode(digest);
}

function genRandom(){ 
    const arr = new Uint8Array(32); 
    crypto.getRandomValues(arr); 
    return base64urlencode(arr);
}

// Alternative solutions
function useCognitoDomain() {
    const solutionsDiv = document.getElementById('solutions');
    solutionsDiv.innerHTML += `
        <div class="test-result warning">
            <h4>Using Default Cognito Domain</h4>
            <p>Your default Cognito domain looks like: <code>your-pool-id.auth.us-east-1.amazoncognito.com</code></p>
            <p>To find it:</p>
            <ol>
                <li>Go to AWS Cognito Console</li>
                <li>Select your User Pool</li>
                <li>Go to "App integration" ‚Üí "Domain name"</li>
                <li>Look for the "Cognito domain" section</li>
            </ol>
            <p><strong>Format:</strong> <code>[pool-name]-[random].auth.[region].amazoncognito.com</code></p>
        </div>
    `;
}

function showManualConfig() {
    const solutionsDiv = document.getElementById('solutions');
    solutionsDiv.innerHTML += `
        <div class="test-result warning">
            <h4>Manual Configuration Steps</h4>
            <p><strong>1. Check Cognito Domain Status:</strong></p>
            <ul>
                <li>AWS Console ‚Üí Cognito ‚Üí User Pools ‚Üí Your Pool ‚Üí App Integration ‚Üí Domain Name</li>
                <li>Status should be "Active"</li>
                <li>CloudFront distribution should be created</li>
            </ul>
            
            <p><strong>2. Check ACM Certificate:</strong></p>
            <ul>
                <li>Certificate for auth.theweer.com must be in us-east-1 region</li>
                <li>Certificate status should be "Issued"</li>
            </ul>
            
            <p><strong>3. Check Route53 Configuration:</strong></p>
            <ul>
                <li>CNAME record for auth.theweer.com should point to the CloudFront distribution</li>
                <li>Distribution domain looks like: d-[random].cloudfront.net</li>
            </ul>
            
            <p><strong>4. Common Issues:</strong></p>
            <ul>
                <li>Certificate in wrong region (must be us-east-1 for CloudFront)</li>
                <li>DNS propagation delay (can take up to 48 hours)</li>
                <li>CloudFront distribution not deployed</li>
            </ul>
        </div>
    `;
}

// Run initial tests
setTimeout(() => {
    testDNS();
    testSSL();
}, 1000);
</script>
</body>
</html>
