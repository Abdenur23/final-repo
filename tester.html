<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cognito Auth with Real-time Updates</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
.container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
h1,h2,h3 { color:#333; }
#auth-action { margin-bottom: 20px; }
#auth-action button { padding:10px 20px; font-size:16px; background-color:#f90; color:white; border:none; border-radius:5px; cursor:pointer; margin:5px; }
#token-display pre { background:#eee; padding:10px; border-radius:4px; overflow-x:auto; }
.status { padding: 10px; margin: 10px 0; border-radius: 4px; }
.connected { background: #d4edda; color: #155724; }
.disconnected { background: #f8d7da; color: #721c24; }
.message { background: #e2e3e5; padding: 8px; margin: 5px 0; border-radius: 4px; }
</style>
</head>
<body>

<div class="container">
    <h1>AWS Cognito Authentication with Real-time Updates</h1>
    <div id="auth-action"></div>

    <div id="token-display"><h2>Not signed in</h2></div>

    <div id="subscriptionSection" style="display:none;">
        <h2>Real-time Updates</h2>
        <div id="connectionStatus" class="status disconnected">Disconnected</div>
        <div id="messages"></div>
    </div>
</div>

<script>
const cognitoConfig = {
    clientId: '7irso7dmmnp793egs9bhkl0t81',
    domain: 'auth.theweer.com',
    redirectUri: window.location.origin + window.location.pathname
};

// WebSocket configuration - YOU'LL NEED TO UPDATE THIS
const websocketConfig = {
    // Replace with your WebSocket API URL
    endpoint: 'wss://your-websocket-api-id.execute-api.us-east-1.amazonaws.com/prod'
};

let websocket = null;

function saveSession(tokens){ localStorage.setItem('cognitoSession', JSON.stringify(tokens)); }
function getSession(){ return JSON.parse(localStorage.getItem('cognitoSession')); }

function showAuthUI(){ 
    const authDiv = document.getElementById('auth-action');
    authDiv.innerHTML = `
        <button onclick="signin()">Sign In / Sign Up</button>
        <button onclick="signout()">Sign Out</button>
    `;
}

function signin(){
    window.location.href = `https://${cognitoConfig.domain}/login?client_id=${cognitoConfig.clientId}&response_type=token&scope=email+openid+profile&redirect_uri=${encodeURIComponent(cognitoConfig.redirectUri)}`;
}

function signout(){
    localStorage.removeItem('cognitoSession');
    if (websocket) {
        websocket.close();
        websocket = null;
    }
    location.reload();
}

function parseHashTokens(){
    if(location.hash){
        const hash = location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const id_token = params.get('id_token');
        const access_token = params.get('access_token');
        if(id_token && access_token){
            saveSession({id_token, access_token});
            location.hash = '';
        }
    }
}

function showSessionInfo(){
    const session = getSession();
    const tokenDiv = document.getElementById('token-display');
    if(session && session.id_token){
        const payload = JSON.parse(atob(session.id_token.split('.')[1]));
        tokenDiv.innerHTML = `<h2>Signed in as ${payload.email || payload.sub}</h2>
        <pre>${JSON.stringify(payload, null, 2)}</pre>`;
        document.getElementById('subscriptionSection').style.display = 'block';
        
        // Automatically connect to WebSocket after sign in
        connectWebSocket();
    } else {
        tokenDiv.innerHTML = `<h2>Not signed in</h2>`;
        document.getElementById('subscriptionSection').style.display = 'none';
    }
}

function connectWebSocket() {
    const session = getSession();
    if (!session || !session.id_token) return;

    try {
        // Close existing connection if any
        if (websocket) {
            websocket.close();
        }

        // Connect to WebSocket with authentication token
        websocket = new WebSocket(`${websocketConfig.endpoint}?token=${session.id_token}`);
        
        websocket.onopen = () => {
            updateConnectionStatus('connected', 'Connected to real-time updates');
            console.log('WebSocket connected');
            
            // Send subscription message for this user
            const payload = JSON.parse(atob(session.id_token.split('.')[1]));
            const subscribeMessage = {
                action: 'subscribe',
                sub: payload.sub
            };
            websocket.send(JSON.stringify(subscribeMessage));
        };

        websocket.onmessage = (event) => {
            const message = JSON.parse(event.data);
            addMessage(`Received: ${JSON.stringify(message)}`);
            
            // Handle image creation events
            if (message.type === 'imageCreated') {
                addMessage(`üéâ New image ready! URL: ${message.imageUrl}`);
                // Here you would render the image in your UI
            }
        };

        websocket.onclose = () => {
            updateConnectionStatus('disconnected', 'Disconnected from real-time updates');
            console.log('WebSocket disconnected');
            
            // Attempt to reconnect after 3 seconds
            setTimeout(() => {
                if (getSession()) {
                    connectWebSocket();
                }
            }, 3000);
        };

        websocket.onerror = (error) => {
            updateConnectionStatus('disconnected', 'Connection error');
            console.error('WebSocket error:', error);
        };

    } catch (error) {
        console.error('Failed to connect WebSocket:', error);
        addMessage(`‚ùå WebSocket connection failed: ${error.message}`);
    }
}

function updateConnectionStatus(status, message) {
    const statusDiv = document.getElementById('connectionStatus');
    statusDiv.textContent = message;
    statusDiv.className = `status ${status}`;
}

function addMessage(text) {
    const messagesDiv = document.getElementById('messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message';
    messageDiv.textContent = `${new Date().toLocaleTimeString()}: ${text}`;
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Initialize
parseHashTokens();
showAuthUI();
showSessionInfo();
</script>

</body>
</html>
