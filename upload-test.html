<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Image Upload Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #f5f5f5;
    }
    .upload-box {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: center;
      width: 350px;
    }
    input[type=file] {
      margin: 15px 0;
    }
    button {
      background: #0073bb;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    button:hover:enabled {
      background: #005fa3;
    }
    #status {
      margin-top: 20px;
      color: green;
      font-size: 0.95em;
      line-height: 1.4;
      text-align: left;
    }
    .privacy-box {
      margin-top: 10px;
      text-align: left;
      font-size: 0.9em;
      color: #444;
    }
  </style>
</head>
<body>
  <div class="upload-box">
    <h2>Upload 3 Images to S3</h2>

    <div class="privacy-box">
      <p><strong>Privacy Policy</strong></p>
      <p>Your uploaded images are processed securely and stored privately in our system. We do not share, sell, or publish your data. By checking this box, you acknowledge and consent to our terms.</p>
      <label>
        <input type="checkbox" id="privacyCheck" onchange="toggleInput()" />
        I have read and agree to the Privacy Policy.
      </label>
    </div>

    <input type="file" id="fileInput" accept="image/*" multiple disabled />
    <p><small>Please select exactly 3 images.</small></p>

    <button id="uploadBtn" onclick="uploadImages()" disabled>Upload All</button>
    <div id="status"></div>
  </div>

  <script>
    // 🔧 REPLACE THIS WITH YOUR ACTUAL API GATEWAY URL
    const API_ENDPOINT = "https://4gl7b1qkn7.execute-api.us-east-1.amazonaws.com/first_stage/upload";

    function toggleInput() {
      const check = document.getElementById("privacyCheck").checked;
      document.getElementById("fileInput").disabled = !check;
      document.getElementById("uploadBtn").disabled = !check;
    }

    async function uploadImages() {
      const fileInput = document.getElementById("fileInput");
      const statusDiv = document.getElementById("status");
      const files = Array.from(fileInput.files);

      statusDiv.textContent = "";

      if (files.length !== 3) {
        alert("You must select exactly 3 images.");
        return;
      }

      statusDiv.textContent = "Requesting upload URLs...";

      try {
        // Step 1: Request presigned URLs for all 3 images
        const filePayload = files.map(f => ({
          fileName: f.name,
          contentType: f.type
        }));

        const response = await fetch(API_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ files: filePayload })
        });

        const data = await response.json();
        if (!data.urls || data.urls.length !== 3) {
          throw new Error(data.error || "Unexpected response from server.");
        }

        // Step 2: Upload each file to its presigned URL
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const urlData = data.urls[i];
          statusDiv.textContent += `\nUploading ${file.name}...`;

          const upload = await fetch(urlData.uploadURL, {
            method: "PUT",
            headers: { "Content-Type": file.type },
            body: file
          });

          if (upload.status === 200) {
            statusDiv.textContent += ` ✅ (${file.name} uploaded)\n`;
          } else {
            statusDiv.textContent += ` ❌ (${file.name} failed - ${upload.status})\n`;
          }
        }

        statusDiv.textContent += "\nAll uploads attempted.";
      } catch (err) {
        console.error(err);
        statusDiv.textContent = "Error: " + err.message;
      }
    }
  </script>
</body>
</html>
