<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cognito Auth Tester (PKCE)</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
.container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
h1,h2,h3 { color:#333; }
#auth-action { margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px; }
#token-display pre { background:#eee; padding:10px; border-radius:4px; overflow-x:auto; }
#token-display textarea { width:100%; height:100px; padding:10px; box-sizing:border-box; border:1px solid #ccc; border-radius:4px; resize:none; font-family:monospace; }
#uploadSection { margin-top:20px; }
#uploadSection input { margin-bottom:10px; }
#uploadSection button { padding:10px 20px; font-size:16px; background-color:#28a745; color:white; border:none; border-radius:5px; cursor:pointer; }
#uploadResult { margin-top:10px; font-weight:bold; }

/* Device selection styles */
.device-selection { margin: 20px 0; }
.brand-selection { margin-bottom: 15px; }
.brand-option { margin-right: 15px; }
.acknowledge-section { 
    margin: 15px 0; 
    padding: 10px; 
    background-color: #fff9e6; 
    border: 1px solid #ffd166;
    border-radius: 5px;
    display: none;
}
.acknowledge-section p { margin: 0 0 10px 0; font-size: 14px; }
.acknowledge-section label { display: flex; align-items: flex-start; }
.acknowledge-section input { margin-right: 8px; margin-top: 2px; }

/* Auth required message */
.auth-required { 
    padding: 20px; 
    background: #fff3cd; 
    border: 1px solid #ffeaa7; 
    border-radius: 5px; 
    text-align: center; 
    margin: 20px 0; 
}

/* Promo code section - ALWAYS VISIBLE when authenticated */
.promo-section { 
    margin: 20px 0; 
    padding: 15px; 
    background: #f8f9fa; 
    border-radius: 8px; 
    border: 1px solid #e9ecef;
}
.promo-input-group { display: flex; gap: 10px; margin-bottom: 10px; }
.promo-input-group input { flex: 1; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; }
.promo-input-group button { padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; }
.promo-message { font-size: 14px; margin-top: 5px; }
.active-promo-badge {
    background: #28a745;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    margin-left: 10px;
}

/* Start over button */
.start-over-section { 
    text-align: center; 
    margin: 20px 0; 
    padding: 15px; 
    display: none;
}
.start-over-btn { 
    padding: 12px 24px; 
    background: #6c757d; 
    color: white; 
    border: none; 
    border-radius: 6px; 
    cursor: pointer;
    font-size: 16px;
}
.start-over-btn:hover { background: #5a6268; }

/* Upload success message */
.upload-success { 
    padding: 15px; 
    background: #d4edda; 
    border: 1px solid #c3e6cb; 
    border-radius: 5px; 
    color: #155724;
    margin: 15px 0;
    text-align: center;
}
</style>
</head>
<body>

<div class="container">
    <div id="nav-container"></div>
    
    <h1>AWS Cognito Authentication Status</h1>
    <div id="auth-action"></div>

    <div id="token-display"><h2>Not signed in</h2></div>
    
    <div id="app-content" style="display: none;">
        <div class="device-selection">
            <h2>Select Your Device</h2>
            
            <div class="brand-selection">
                <label class="brand-option">
                    <input type="radio" name="brand" value="apple" checked> Apple
                </label>
                <label class="brand-option">
                    <input type="radio" name="brand" value="samsung"> Samsung
                </label>
            </div>
            
            <label for="deviceSelect">Model:</label>
            <select id="deviceSelect">
                <option value="">-- Choose Model --</option>
            </select>
            
            <div class="acknowledge-section" id="acknowledgeSection">
                <p style="margin: 0 0 10px 0; font-size: 14px;">
                    <strong>Important:</strong> For demonstration, we'll show your design on <span id="demoDevice">iPhone 16 Pro Max</span>. 
                    Your actual order will be custom-made specifically for your selected device: <strong id="selectedDevice"></strong>.
                </p>
                <label>
                    <input type="checkbox" id="acknowledgeCheckbox"> I understand my case and wallpaper will be custom-made for: <strong id="deviceName"></strong>
                </label>
            </div>
        </div>

        <!-- Promo Code Section - ALWAYS VISIBLE when authenticated -->
        <div class="promo-section" id="promoSection">
            <h3>üí≥ Have a Promo Code? 
                <span id="activePromoBadge" class="active-promo-badge" style="display: none;">
                    Active: <span id="activePromoPercent">0</span>% OFF
                </span>
            </h3>
            <div class="promo-input-group">
                <input type="text" id="promoCodeInput" placeholder="Enter promo code">
                <button onclick="applyPromoCode()">Apply</button>
            </div>
            <div id="promoMessage" class="promo-message"></div>
        </div>

        <div id="uploadSection" style="display:none;">
            <h2>Upload 3 Images</h2>
            <input type="file" id="fileInput" multiple accept="image/*">
            <br>
            <button onclick="uploadFiles()">Upload Images</button>
            <div id="uploadResult"></div>
        </div>

        <!-- Start Over Section -->
        <div class="start-over-section" id="startOverSection">
            <button class="start-over-btn" onclick="startOver()">Start Over with New Images</button>
        </div>
    </div>
    
    <div id="auth-required-message" class="auth-required" style="display: none;">
        <h3>Authentication Required</h3>
        <p>Please sign in to access the phone case customization features.</p>
        <button onclick="signin()" style="padding: 10px 20px; background: #f90; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
            Sign In / Sign Up
        </button>
    </div>
</div>

<script src="auth.js"></script>
<script>
// --- CONFIG ---
const CONFIG = {
    productPrice: 34.00
};

// --- GLOBAL STATE ---
let selectedFiles = [];
let activePromoDiscount = 0; // Always use the highest valid discount
let completedDesignsCount = 0;
const totalExpectedDesigns = 3;

// Load promo discount from localStorage on page load
function loadPromoDiscount() {
    const savedDiscount = localStorage.getItem('activePromoDiscount');
    if (savedDiscount !== null) {
        activePromoDiscount = parseInt(savedDiscount);
        updatePromoBadge();
        updateAllProductPrices();
    }
}

// Save promo discount to localStorage
function savePromoDiscount() {
    localStorage.setItem('activePromoDiscount', activePromoDiscount.toString());
}

// Update the active promo badge
function updatePromoBadge() {
    const badge = document.getElementById('activePromoBadge');
    const percentSpan = document.getElementById('activePromoPercent');
    
    if (activePromoDiscount > 0) {
        percentSpan.textContent = activePromoDiscount;
        badge.style.display = 'inline-block';
    } else {
        badge.style.display = 'none';
    }
}

// --- DEVICE DATA AND LOGIC ---
const devices = {
    apple: [
        { name: "iPhone 17", value: "iphone17" },
        { name: "iPhone Air", value: "iphoneair" },
        { name: "iPhone 17 Pro", value: "iphone17pro" },
        { name: "iPhone 17 Pro Max", value: "iphone17promax" },
        { name: "iPhone 16", value: "iphone16" },
        { name: "iPhone 16e", value: "iphone16e" },
        { name: "iPhone 16 Plus", value: "iphone16plus" },
        { name: "iPhone 16 Pro", value: "iphone16pro" },
        { name: "iPhone 16 Pro Max", value: "iphone16promax" },
        { name: "iPhone 14", value: "iphone14" },
        { name: "iPhone 14 Plus", value: "iphone14plus" },
        { name: "iPhone 14 Pro", value: "iphone14pro" },
        { name: "iPhone 14 Pro Max", value: "iphone14promax" }
    ],
    samsung: [
        { name: "Galaxy S25", value: "samsungs25" },
        { name: "Galaxy S25+", value: "samsungs25plus" },
        { name: "Galaxy S25 Ultra", value: "samsungs25ultra" },
        { name: "Galaxy S24", value: "samsungs24" },
        { name: "Galaxy S24+", value: "samsungs24plus" },
        { name: "Galaxy S24 Ultra", value: "samsungs24ultra" },
        { name: "Galaxy S23", value: "samsungs23" },
        { name: "Galaxy S23+", value: "samsungs23plus" },
        { name: "Galaxy S22", value: "samsungs22" },
        { name: "Galaxy S21", value: "samsungs21" }
    ]
};

// --- PROMO CODE FUNCTIONS ---
async function applyPromoCode() {
    const promoCode = document.getElementById('promoCodeInput').value.trim();
    const messageDiv = document.getElementById('promoMessage');
    
    if (!promoCode) {
        messageDiv.innerHTML = '<span style="color: #dc3545;">Please enter a promo code</span>';
        return;
    }

    const token = getSession()?.id_token;
    if (!token) {
        messageDiv.innerHTML = '<span style="color: #dc3545;">Please sign in first</span>';
        return;
    }

    try {
        messageDiv.innerHTML = '<span style="color: #6c757d;">Validating promo code...</span>';
        
        const response = await fetch('https://y4vn8tdr5g.execute-api.us-east-1.amazonaws.com/prod/upload', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ 
                action: 'validatePromo',
                promo_code: promoCode
            })
        });

        console.log('Promo validation response status:', response.status);
        
        if (response.ok) {
            const result = await response.json();
            console.log('Promo validation result:', result);
            
            if (result.valid === true || result.discount_percentage > 0) {
                const newDiscount = result.discount_percentage || 30;
                
                // Only update if the new discount is higher than current active discount
                if (newDiscount > activePromoDiscount) {
                    activePromoDiscount = newDiscount;
                    savePromoDiscount();
                    updatePromoBadge();
                    updateAllProductPrices();
                    
                    messageDiv.innerHTML = `<span style="color: #28a745;">‚úÖ Promo code applied! ${activePromoDiscount}% discount activated and will apply to all products</span>`;
                } else {
                    messageDiv.innerHTML = `<span style="color: #ffc107;">‚ÑπÔ∏è You already have an active ${activePromoDiscount}% discount. This code offers ${newDiscount}% which is not better.</span>`;
                }
                
                // Clear the input field on successful validation
                document.getElementById('promoCodeInput').value = '';
                
            } else {
                // Invalid promo code - but keep current active discount if any
                messageDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Invalid promo code</span>';
                
                if (activePromoDiscount > 0) {
                    messageDiv.innerHTML += `<br><span style="color: #17a2b8;">Your current ${activePromoDiscount}% discount remains active.</span>`;
                }
            }
        } else {
            const errorText = await response.text();
            console.error('Promo validation error response:', errorText);
            messageDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Error validating promo code</span>';
            
            if (activePromoDiscount > 0) {
                messageDiv.innerHTML += `<br><span style="color: #17a2b8;">Your current ${activePromoDiscount}% discount remains active.</span>`;
            }
        }
    } catch (error) {
        console.error('Promo code network error:', error);
        messageDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Network error validating promo code</span>';
        
        if (activePromoDiscount > 0) {
            messageDiv.innerHTML += `<br><span style="color: #17a2b8;">Your current ${activePromoDiscount}% discount remains active.</span>`;
        }
    }
}

function updateAllProductPrices() {
    const productCards = document.querySelectorAll('.product-card');
    productCards.forEach(card => {
        updateProductPrice(card);
    });
}

function updateProductPrice(productCard) {
    const originalPrice = CONFIG.productPrice;
    const discountedPrice = originalPrice * (1 - activePromoDiscount / 100);
    
    const priceElement = productCard.querySelector('.product-price');
    const cartButton = productCard.querySelector('.add-to-cart-btn');
    
    if (activePromoDiscount > 0) {
        priceElement.innerHTML = `
            <span style="text-decoration: line-through; color: #6c757d; margin-right: 8px;">$${originalPrice.toFixed(2)}</span>
            <span style="color: #28a745;">$${discountedPrice.toFixed(2)}</span>
            <div style="font-size: 12px; color: #28a745;">${activePromoDiscount}% OFF</div>
        `;
        cartButton.textContent = `Add to Cart - $${discountedPrice.toFixed(2)}`;
    } else {
        priceElement.textContent = `$${originalPrice.toFixed(2)}`;
        cartButton.textContent = `Add to Cart - $${originalPrice.toFixed(2)}`;
    }
}

// --- UPLOAD CONTROL FUNCTIONS ---
function hideUploadSection() {
    document.getElementById('uploadSection').style.display = 'none';
    // NOTE: Promo section stays visible always
}

function showStartOverButton() {
    document.getElementById('startOverSection').style.display = 'block';
}

function showUploadSection() {
    document.getElementById('uploadSection').style.display = 'block';
    document.getElementById('startOverSection').style.display = 'none';
    // Promo section is always visible, no need to show/hide it
}

function startOver() {
    // Clear all displayed products and updates
    const updatesContainer = document.getElementById('realtimeUpdates');
    const productsContainer = document.getElementById('productsContainer');
    
    if (updatesContainer) updatesContainer.innerHTML = '';
    if (productsContainer) productsContainer.innerHTML = '';
    
    // Reset state (but keep promo discount!)
    completedDesignsCount = 0;
    selectedFiles = [];
    document.getElementById('fileInput').value = '';
    document.getElementById('uploadResult').innerHTML = '';
    
    // Reset realtime updates (but keep promo discount!)
    if (window.realtimeUpdates) {
        window.realtimeUpdates.pendingImages.clear();
        window.realtimeUpdates.completedDesigns.clear();
        window.realtimeUpdates.processedFiles.clear();
        window.realtimeUpdates.hasDisplayedProduct = false;
        window.realtimeUpdates.completedDesignsCount = 0;
    }
    
    // Show upload section again
    showUploadSection();
}

// --- API CALL FUNCTIONS ---
async function updateCustomerDevice(deviceId) {
    const token = getSession()?.id_token; 
    if (!token) {
        console.log('User not signed in, skipping device update');
        return; 
    }
    
    try {
        console.log('üöÄ Calling Lambda to update device:', deviceId);
        const response = await fetch('https://y4vn8tdr5g.execute-api.us-east-1.amazonaws.com/prod/upload', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ 
                device_id: deviceId,
                action: 'updateDevice'
            })
        });
        
        console.log('üì° API Response status:', response.status);
        if (response.ok) {
            const result = await response.json();
            console.log('‚úÖ Device updated successfully:', result);
        } else {
            const error = await response.text();
            console.error('‚ùå Failed to update device:', error);
        }
    } catch (error) {
        console.error('üí• Error updating device:', error);
    }
}

document.getElementById('fileInput').addEventListener('change', (e)=>{
    selectedFiles = Array.from(e.target.files);
    if(selectedFiles.length !== 3) alert("Please select exactly 3 images");
});

async function uploadFiles() {
    const token = getSession()?.id_token;
    const deviceId = document.getElementById('deviceSelect').value;

    if (!token) return alert('Please sign in first');
    if (!deviceId) return alert('Please select a device before uploading');
    if (selectedFiles.length !== 3) return alert('Please select exactly 3 images');

    // Show upload success message IMMEDIATELY
    const resultDiv = document.getElementById('uploadResult');
    resultDiv.innerHTML = '<div class="upload-success">‚úÖ All 3 files uploaded successfully! Processing started...</div>';

    // Hide upload section immediately after upload
    hideUploadSection();

    const filesData = selectedFiles.map((f, i) => ({
        fileId: i + 1,
        fileName: f.name,
        fileType: f.type
    }));

    try {
        const res = await fetch('https://y4vn8tdr5g.execute-api.us-east-1.amazonaws.com/prod/upload', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ files: filesData, device_id: deviceId })
        });

        const data = await res.json();

        if (!res.ok || !data.uploadUrls) {
            resultDiv.innerHTML = `<div style="color: #dc3545;">‚ùå Upload failed: ${data.error || JSON.stringify(data)}</div>`;
            showUploadSection(); // Show upload section again if failed
            return;
        }

        // Upload files to S3
        const uploadPromises = data.uploadUrls.map(async (u, idx) => {
            const uploadResponse = await fetch(u.uploadUrl, {
                method: 'PUT',
                body: selectedFiles[idx],
                headers: { 'Content-Type': selectedFiles[idx].type }
            });

            if (uploadResponse.ok) {
                const notificationPayload = {
                    action: 'uploadComplete',
                    fileKey: u.key,
                    metadata: {
                        fileName: u.fileName,
                        priority: u.priority,
                        srcid: u.srcid,
                        palette_id: u.palette_id,
                        flavor: u.flavor,
                        cid: data.cid,
                        device_id: deviceId 
                    }
                };

                // Notify Lambda about upload completion
                fetch('https://y4vn8tdr5g.execute-api.us-east-1.amazonaws.com/prod/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify(notificationPayload)
                });
            }

            return uploadResponse;
        });

        await Promise.all(uploadPromises);
        // Success message already shown above - it stays visible
        
    } catch (e) {
        resultDiv.innerHTML = `<div style="color: #dc3545;">‚ùå Error uploading files: ${e.message}</div>`;
        showUploadSection(); // Show upload section again if failed
    }
    
    if (window.realtimeUpdates) {
        window.realtimeUpdates.showPanel();
    }
}

// --- UI MANAGEMENT ---
function showSessionInfo() {
    const userInfo = getUserInfo();
    const tokenDiv = document.getElementById('token-display');
    
    if (userInfo) {
        const session = getSession();
        const payload = JSON.parse(atob(session.id_token.split('.')[1]));
        tokenDiv.innerHTML = `<h2>Signed in as ${userInfo.displayName}</h2>
        <pre>${JSON.stringify(payload, null, 2)}</pre>`;

        if (!window.realtimeUpdates) {
            window.realtimeUpdates = new RealTimeUpdates();
            window.realtimeUpdates.initialize();
        }
    } else {
        tokenDiv.innerHTML = `<h2>Not signed in</h2>`;
    }
}

function toggleAppContent(show) {
    const appContent = document.getElementById('app-content');
    const authRequired = document.getElementById('auth-required-message');
    const promoSection = document.getElementById('promoSection');
    
    if (show) {
        appContent.style.display = 'block';
        authRequired.style.display = 'none';
        promoSection.style.display = 'block'; // Always show promo when authenticated
        initializeDeviceOptions();
    } else {
        appContent.style.display = 'none';
        authRequired.style.display = 'block';
        promoSection.style.display = 'none';
    }
}

function initializeDeviceOptions() {
    updateDeviceOptions();
    
    const brandRadios = document.querySelectorAll('input[name="brand"]');
    brandRadios.forEach(radio => {
        radio.addEventListener('change', updateDeviceOptions);
    });
    
    const deviceSelect = document.getElementById('deviceSelect');
    deviceSelect.addEventListener('change', showAcknowledgeSection);
    
    const acknowledgeCheckbox = document.getElementById('acknowledgeCheckbox');
    acknowledgeCheckbox.addEventListener('change', toggleUploadSection);
}

function updateDeviceOptions() {
    const selectedBrand = document.querySelector('input[name="brand"]:checked').value;
    const deviceSelect = document.getElementById('deviceSelect');
    deviceSelect.innerHTML = '<option value="">-- Choose Model --</option>';
    
    if (!selectedBrand || !devices[selectedBrand]) return;
    
    devices[selectedBrand].forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.value;
        opt.textContent = d.name;
        deviceSelect.appendChild(opt);
    });
    
    document.getElementById('acknowledgeSection').style.display = 'none';
    document.getElementById('uploadSection').style.display = 'none';
    document.getElementById('acknowledgeCheckbox').checked = false;
}

function showAcknowledgeSection() {
    const deviceSelect = document.getElementById('deviceSelect');
    const acknowledgeSection = document.getElementById('acknowledgeSection');
    
    if (deviceSelect.value) {
        const selectedDevice = deviceSelect.options[deviceSelect.selectedIndex].text;
        const deviceValue = deviceSelect.value;
        
        document.getElementById('selectedDevice').textContent = selectedDevice;
        document.getElementById('deviceName').textContent = selectedDevice;
        acknowledgeSection.style.display = 'block';
        
        console.log('üîÑ Device selected, updating database...');
        updateCustomerDevice(deviceValue);
    } else {
        acknowledgeSection.style.display = 'none';
        document.getElementById('uploadSection').style.display = 'none';
    }
}

function toggleUploadSection() {
    const acknowledgeCheckbox = document.getElementById('acknowledgeCheckbox');
    const uploadSection = document.getElementById('uploadSection');
    
    if (acknowledgeCheckbox.checked) {
        uploadSection.style.display = 'block';
    } else {
        uploadSection.style.display = 'none';
    }
}

// Initialize application
async function initializeApp() {
    const isAuth = await initializeAuth();
    showSessionInfo();
    toggleAppContent(isAuth);
    loadPromoDiscount(); // Load saved promo discount
}

// Start the application
document.addEventListener('DOMContentLoaded', initializeApp);
</script>

<link rel="stylesheet" href="realtime-updates.css">
<script src="realtime-updates.js"></script>
</body>
</html>
