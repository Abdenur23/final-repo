<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom Phone Cases</title>
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/realtime-updates.css">
  <style>
    .cart-btn {
      position: relative;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
      padding: 8px;
    }
    .cart-count {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #dc3545;
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .gift-option:hover {
      border-color: #007bff;
      background: #f0f8ff;
    }
    
    /* New styles for checkout form */
    .address-group {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .address-group input, .address-group select {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .address-group h4 {
      margin-top: 0;
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }
    .form-row {
      display: flex;
      gap: 10px;
    }
    .form-row > div {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="text-align: center; margin: 20px 0;">
      <img src="logo.png" alt="Logo" style="height: 60px;">
    </div>
    <div id="nav-container"></div>
        <div style="text-align: right; margin: 10px 0;">
      <button id="cart-button" class="cart-btn">
        🛒
        <span id="cart-count" class="cart-count" style="display: none;">0</span>
      </button>
    </div>
    <h1 style="text-align:center; margin-bottom:24px;">Custom Phone Cases</h1>
    <div id="auth-action"></div>
    <div id="token-display">
      <h2>Not signed in</h2>
    </div>
    <div id="app-content" style="display: none;">
      <div class="device-selection">
        <h2>Select Your Phone Model to Start</h2>
        <div class="brand-selection">
          <label class="brand-option">
            <input type="radio" name="brand" value="apple" checked> Apple
          </label>
          <label class="brand-option">
            <input type="radio" name="brand" value="samsung"> Samsung
          </label>
        </div>
        <label for="deviceSelect">Model:</label>
        <select id="deviceSelect">
          <option value="">-- Choose Model --</option>
        </select>
        <div class="acknowledge-section" id="acknowledgeSection">
          <p style="margin: 0 0 10px 0; font-size: 14px;">
            <strong>Important:</strong> For demonstration, we'll show your design on
            <span id="demoDevice">iPhone 16 Pro Max</span>. Your actual order will be custom-made
            specifically for your selected device: <strong id="selectedDevice"></strong>.
          </p>
          <label>
            <input type="checkbox" id="acknowledgeCheckbox">
            I understand my case and wallpaper will be custom-made for:
            <strong id="deviceName"></strong>
          </label>
        </div>
      </div>
            <div class="promo-section" id="promoSection">
        <h3>
          💳 Have a Promo Code?
          <span id="activePromoBadge" class="active-promo-badge" style="display: none;">
            Active: <span id="activePromoPercent">0</span>% OFF
          </span>
        </h3>
        <div class="promo-input-group">
          <input type="text" id="promoCodeInput" placeholder="Enter promo code">
          <button onclick="window.app.applyPromoCode()">Apply</button>
        </div>
        <div id="promoMessage" class="promo-message"></div>
      </div>
      <div id="uploadSection" style="display:none;">
        <h2>Upload 3 Images</h2>
        <input type="file" id="fileInput" multiple accept="image/*">
        <br>
        <button onclick="window.app.uploadFiles()">Upload Images</button>
        <div id="uploadResult"></div>
      </div>
            <div class="start-over-section" id="startOverSection">
        <button class="start-over-btn" onclick="window.app.startOver()">
          Start Over with New Images
        </button>
      </div>
    </div>
    <div id="auth-required-message" class="auth-required" style="display: none;">
      <h3>Authentication Required</h3>
      <p>Please sign in to access the phone case customization features.</p>
      <button onclick="signin()" style="padding: 10px 20px; background: #f90; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
        Sign In / Sign Up
      </button>
    </div>
  </div>
    <div id="cart-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 24px; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.15);">
        
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;" id="modal-title">🛒 Shopping Cart</h2>
        <button onclick="window.stripePayment.closeCartModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">×</button>
      </div>

            <div id="cart-summary-step">
          <div id="cart-items-container" style="margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
                      </div>
         
                    <div class="gift-option" style="background: #f8fbff; padding: 16px; border: 2px solid #e6f2ff; border-radius: 8px; margin: 16px 0;">
              <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                  <input type="checkbox" id="gift-checkbox" style="width: 18px; height: 18px; margin-right: 12px; cursor: pointer;">
                  <div>
                      <div style="font-weight: 600; color: #0056b3; margin-bottom: 4px;">🎁 Send as a gift</div>
                      <div style="color: #666; font-size: 13px; line-height: 1.4;">
                          We'll wrap it beautifully and ship directly to your recipient
                      </div>
                      <div style="color: #d4af37; font-weight: 600; font-size: 13px; margin-top: 6px;">+ $<span id="gift-fee-display">12.00</span> gift service</div>
                  </div>
              </label>
          </div>
          <script>
          // Add gift checkbox event listener
          document.getElementById('gift-checkbox').addEventListener('change', function() {
              window.stripePayment.toggleGiftOption();
          });
          </script>
         
          <div style="border-top: 1px solid #eee; padding-top: 16px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
              <span>Subtotal:</span>
              <span>$<span id="cart-subtotal">0.00</span></span>
            </div>
            <div id="gift-fee-line" style="display: none; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
              <span>Gift service:</span>
              <span style="color: #d4af37;">$<span id="gift-fee">0.00</span></span>
            </div>
                        <div id="tax-line" style="display: none; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #28a745;">
              <span>Estimated Taxes:</span>
              <span>$<span id="estimated-taxes">0.00</span></span>
            </div>
            
            <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; margin-bottom: 20px; padding-top: 8px; border-top: 1px solid #eee;">
              <span>Total:</span>
              <span style="color: #2c5530;">$<span id="cart-total">0.00</span></span>
            </div>
           
            <button id="next-to-shipping"
                    style="background: #007bff; color: white; border: none; padding: 16px; border-radius: 8px; width: 100%; cursor: pointer; font-size: 16px; font-weight: 600; transition: background 0.2s;">
              Proceed to Shipping
            </button>
           
            <p style="text-align: center; color: #666; margin-top: 16px; font-size: 13px;">
              Next step: Shipping details and Payment
            </p>
          </div>
      </div>
        
            <div id="checkout-address-step" style="display: none;">
        <form id="address-form">
            
                    <div class="address-group">
            <h4>Shipping Address</h4>
            <input type="text" id="shippingName" placeholder="Full Name" required>
            <input type="text" id="shippingStreet" placeholder="Street Address" required>
            <div class="form-row">
              <div><input type="text" id="shippingCity" placeholder="City" required></div>
              <div>
                <select id="shippingState" required>
                  <option value="">State</option>
                                    <option value="CA">California</option>
                  <option value="NY">New York</option>
                  <option value="TX">Texas</option>
                                  </select>
              </div>
              <div><input type="text" id="shippingZip" placeholder="Zip Code" required></div>
            </div>
          </div>
         
                    <div style="margin-bottom: 20px;">
            <label>
              <input type="checkbox" id="sameAsShipping" checked>
              Billing address is the same as shipping address
            </label>
          </div>
         
                    <div id="billing-address-fields" class="address-group" style="display: none;">
            <h4>Billing Address</h4>
            <input type="text" id="billingName" placeholder="Full Name" required>
            <input type="text" id="billingStreet" placeholder="Street Address" required>
            <div class="form-row">
              <div><input type="text" id="billingCity" placeholder="City" required></div>
              <div>
                <select id="billingState" required>
                  <option value="">State</option>
                                    <option value="CA">California</option>
                  <option value="NY">New York</option>
                  <option value="TX">Texas</option>
                                  </select>
              </div>
              <div><input type="text" id="billingZip" placeholder="Zip Code" required></div>
            </div>
          </div>
         
          <button type="submit"
                    style="background: #28a745; color: white; border: none; padding: 16px; border-radius: 8px; width: 100%; cursor: pointer; font-size: 16px; font-weight: 600; transition: background 0.2s;">
            Confirm Shipping & Proceed to Payment
          </button>
          <button type="button" onclick="window.stripePayment.showCartSummary()"
                    style="background: #6c757d; color: white; border: none; padding: 10px; border-radius: 8px; width: 100%; cursor: pointer; font-size: 14px; margin-top: 10px;">
            ← Back to Cart
          </button>
        </form>
      </div>

    </div>
  </div>
  <script src="config/constants.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/device-manager.js"></script>
  <script src="js/promo-manager.js"></script>
  <script src="js/upload-manager.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
  <script src="js/stripe-payment.js"></script>
  <script src="js/websocket-manager.js"></script>
  <script src="js/progress-tracker.js"></script>
  <script src="js/ui-components-manager.js"></script>
  <script src="js/image-navigation-handler.js"></script>
  <script src="js/realtime-updates.js"></script>
  <script src="js/app.js"></script>
  <script>
    // Initialize cart button
    document.getElementById('cart-button').addEventListener('click', () => {
      window.stripePayment.openCartModal();
    });
    
    // Add event listener for the "Proceed to Shipping" button
    document.getElementById('next-to-shipping').addEventListener('click', () => {
      window.stripePayment.showCheckoutAddress();
    });

    // Add event listener for the "Same as Shipping" checkbox
    document.getElementById('sameAsShipping').addEventListener('change', (e) => {
      const billingFields = document.getElementById('billing-address-fields');
      billingFields.style.display = e.target.checked ? 'none' : 'block';
      
      // Re-calculate tax when the billing address state visibility changes
      window.stripePayment.updateCartTotal();
    });
    
    // Add event listener to the State dropdowns to recalculate tax
    document.getElementById('shippingState').addEventListener('change', () => {
      if (document.getElementById('sameAsShipping').checked) {
        window.stripePayment.updateCartTotal();
      }
    });
    document.getElementById('billingState').addEventListener('change', () => {
      if (!document.getElementById('sameAsShipping').checked) {
        window.stripePayment.updateCartTotal();
      }
    });
    
    // Add event listener for the address form submission
    document.getElementById('address-form').addEventListener('submit', (e) => {
      e.preventDefault();
      window.stripePayment.handleAddressSubmission();
    });
    
    // Setup function to fill states for demo/testing
    window.fillDemoStates = function(selectId) {
      const select = document.getElementById(selectId);
      const states = ['AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA', 'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD', 'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ', 'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC', 'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'];
      states.forEach(state => {
        if (!select.querySelector(`option[value="${state}"]`)) {
          const option = document.createElement('option');
          option.value = state;
          option.textContent = state;
          select.appendChild(option);
        }
      });
    }
    window.fillDemoStates('shippingState');
    window.fillDemoStates('billingState');
  </script>
</body>
</html>
