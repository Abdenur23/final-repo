<!-- success.html -->
<div id="order-details" style="display: none;">
    <div id="gift-shipping-form" style="display: none;">
        <h2>üéÅ Gift Shipping Details</h2>
        <p>Please provide the shipping address for your gift recipient:</p>
        
        <form id="gift-form">
            <input type="text" name="recipient_name" placeholder="Recipient Name" required>
            <input type="text" name="shipping_line1" placeholder="Street Address" required>
            <input type="text" name="shipping_line2" placeholder="Apt/Suite">
            <input type="text" name="shipping_city" placeholder="City" required>
            <input type="text" name="shipping_state" placeholder="State" required>
            <input type="text" name="shipping_postal_code" placeholder="ZIP Code" required>
            <textarea name="gift_message" placeholder="Gift message (optional)"></textarea>
            <button type="submit">Save Shipping Details</button>
        </form>
    </div>
    
    <div id="regular-confirmation" style="display: none;">
        <h2>‚úÖ Order Confirmed!</h2>
        <p>Your order will be shipped to:</p>
        <div id="shipping-address-display"></div>
        <button onclick="confirmShipping()">Confirm Shipping Address</button>
    </div>
    
    <div id="thank-you" style="display: none;">
        <h2>Thank You for Your Order!</h2>
        <p>Your order is being processed and will ship soon.</p>
    </div>
</div>

<script>
async function displayOrderDetails(sessionData) {
    document.getElementById('loading-message').style.display = 'none';
    document.getElementById('order-details').style.display = 'block';
    
    const isGift = sessionData.is_gift;
    const hasShipping = sessionData.shipping_address;
    
    if (isGift && !hasShipping) {
        // Show gift shipping form
        document.getElementById('gift-shipping-form').style.display = 'block';
        setupGiftForm(sessionData.id);
    } else if (hasShipping) {
        // Show regular confirmation
        document.getElementById('regular-confirmation').style.display = 'block';
        document.getElementById('shipping-address-display').innerHTML = 
            formatAddress(sessionData.shipping_address);
    } else {
        // Should not happen
        document.getElementById('thank-you').style.display = 'block';
    }
}

function setupGiftForm(sessionId) {
    document.getElementById('gift-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        const shippingDetails = {
            name: formData.get('recipient_name'),
            line1: formData.get('shipping_line1'),
            line2: formData.get('shipping_line2'),
            city: formData.get('shipping_city'),
            state: formData.get('shipping_state'),
            postal_code: formData.get('shipping_postal_code')
        };
        
        try {
            const session = getSession();
            const response = await fetch('https://your-api.execute-api.us-east-1.amazonaws.com/prod/upload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${session.id_token}`
                },
                body: JSON.stringify({
                    action: 'saveShippingDetails',
                    session_id: sessionId,
                    shipping_details: shippingDetails,
                    gift_message: formData.get('gift_message')
                })
            });
            
            if (response.ok) {
                document.getElementById('gift-shipping-form').style.display = 'none';
                document.getElementById('thank-you').style.display = 'block';
            }
        } catch (error) {
            alert('Error saving shipping details: ' + error.message);
        }
    });
}

async function confirmShipping() {
    // For regular orders, just mark as completed
    const sessionId = new URLSearchParams(window.location.search).get('session_id');
    
    try {
        const session = getSession();
        await fetch('https://your-api.execute-api.us-east-1.amazonaws.com/prod/upload', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.id_token}`
            },
            body: JSON.stringify({
                action: 'saveShippingDetails',
                session_id: sessionId,
                shipping_details: {}, // Empty for regular orders
                gift_message: ''
            })
        });
        
        document.getElementById('regular-confirmation').style.display = 'none';
        document.getElementById('thank-you').style.display = 'block';
    } catch (error) {
        alert('Error confirming order: ' + error.message);
    }
}
</script>
