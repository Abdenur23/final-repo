<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheWeer.com - Order Status</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* --- Dreamlike Elegance Theme --- */
        :root {
            --color-magenta: #E6007E;
            --color-gold: #D4AF37;
            --color-charcoal: #2E2E2E;
            --color-blush-start: #FFD0E6;
            --color-blush-end: #FFF7FB;
            --color-gray-300: #d1d5db;
            --color-gray-600: #4b5563;
        }
        
        .bg-magenta { background-color: var(--color-magenta); }
        .bg-gold { background-color: var(--color-gold); }
        .text-magenta { color: var(--color-magenta); }
        .text-gold { color: var(--color-gold); }
        .border-magenta { border-color: var(--color-magenta); }
        .border-gold { border-color: var(--color-gold); }

        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=Manrope:wght@400;600&display=swap');
        
        body {
            font-family: 'Manrope', sans-serif;
            background: linear-gradient(135deg, var(--color-blush-start) 0%, var(--color-blush-end) 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: var(--color-charcoal);
        }
        
        .container {
            width: 100%;
            max-width: 960px;
            background: white;
            padding: 32px;
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }
        
        h1, h2, h3, .poetic-title {
            font-family: 'Cormorant Garamond', serif;
            letter-spacing: 0.05em;
        }
        
        .poetic-title {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--color-charcoal);
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .cta-magenta {
            background-color: var(--color-magenta);
            color: white;
            transition: all 0.3s;
        }
        .cta-magenta:hover {
            background-color: #C00063;
            box-shadow: 0 4px 10px rgba(230, 0, 126, 0.4);
            transform: translateY(-2px);
        }
        
        .cta-gold {
            background-color: var(--color-gold);
            color: var(--color-charcoal);
            transition: all 0.3s;
        }
        .cta-gold:hover {
            background-color: #C09A34;
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4);
            transform: translateY(-2px);
        }
        
        .section-background {
            background: linear-gradient(135deg, rgba(255, 208, 230, 0.1) 0%, rgba(255, 247, 251, 0.1) 100%);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(230, 0, 126, 0.1);
        }
        
        .gold-highlight {
            color: var(--color-gold);
            font-weight: 600;
        }
        
        .success-animation {
            animation: bloom 1s ease-out;
        }
        
        @keyframes bloom {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--color-magenta);
            opacity: 0;
            animation: confetti-fall 3s ease-in-out forwards;
            pointer-events: none;
        }
        
        @keyframes confetti-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        
        .error-message {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #b91c1c;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .loading-spinner {
            border: 3px solid rgba(230, 0, 126, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--color-magenta);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .order-item {
            border-bottom: 1px solid rgba(230, 0, 126, 0.1);
            padding: 12px 0;
        }
        .order-item:last-child {
            border-bottom: none;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--color-charcoal);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .auth-badge {
            background-color: rgba(212, 175, 55, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
        }
        
        .product-thumbnail {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid rgba(230, 0, 126, 0.2);
        }
        
        .gift-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .address-box {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid rgba(230, 0, 126, 0.1);
        }
    </style>
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="header flex justify-between items-center pb-4 mb-6 border-b border-gray-200">
            <img src="logo.png" alt="TheWeer.com" class="h-12 w-auto">
            <div id="user-email-display" class="text-sm text-gray-600 auth-badge hidden"></div>
        </header>

        <main class="text-center">
            <!-- Success Icon - Will be hidden for invalid/not paid orders -->
            <div id="success-icon" class="success-animation mb-8" style="display: none;">
                <div class="w-32 h-32 bg-green-100 rounded-full flex items-center justify-center mx-auto border-4 border-green-200">
                    <svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
            </div>

            <!-- Main Success Message - Will be hidden for invalid/not paid orders -->
            <h1 id="success-title" class="poetic-title text-4xl mb-6" style="display: none;">Your Order is Confirmed</h1>
            
            <div id="success-quote" class="text-center italic mb-8" style="display: none;">
                <p class="text-xl text-gray-600 mb-4">"Your reflection has blossomed into art."</p>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="section-background max-w-2xl mx-auto mb-8 p-8">
                <div class="loading-spinner"></div>
                <p class="text-gray-600">Loading your order details...</p>
            </div>

            <!-- Order Details Section - Will only show for PAID orders -->
            <div id="order-details-section" class="max-w-3xl mx-auto mb-8" style="display: none;">
                <!-- Order Header Card -->
                <div class="section-background p-6 mb-6">
                    <h3 class="text-2xl font-semibold mb-4 text-magenta">Order Details</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                        <div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="font-semibold text-gray-600">Order ID:</span>
                                <span id="order-id" class="gold-highlight font-mono text-sm">Loading...</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="font-semibold text-gray-600">Email:</span>
                                <span id="customer-email">Loading...</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="font-semibold text-gray-600">Date:</span>
                                <span id="order-date">Loading...</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="font-semibold text-gray-600">Status:</span>
                                <span id="order-status" class="text-green-600 font-semibold flex items-center gap-1">
                                    <span class="w-2 h-2 bg-green-600 rounded-full animate-pulse"></span>
                                    Processing
                                </span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="font-semibold text-gray-600">Total:</span>
                                <span id="order-total" class="text-magenta font-bold text-lg">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Two Column Address Layout -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Shipping Address -->
                    <div id="shipping-address-section" class="section-background p-6" style="display: none;">
                        <h4 class="font-semibold text-left mb-3 text-magenta flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                            </svg>
                            Shipping Address
                        </h4>
                        <div id="shipping-address" class="text-left text-sm text-gray-600 address-box">
                        </div>
                    </div>

                    <!-- Billing Address -->
                    <div id="billing-address-section" class="section-background p-6" style="display: none;">
                        <h4 class="font-semibold text-left mb-3 text-magenta flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                            Billing Address
                        </h4>
                        <div id="billing-address" class="text-left text-sm text-gray-600 address-box">
                        </div>
                        <div id="billing-same-as-shipping" class="text-left text-xs text-gray-500 mt-2 italic" style="display: none;">
                            Same as shipping address
                        </div>
                    </div>
                </div>

                <!-- Gift Note Section -->
                <div id="gift-note-section" class="section-background p-6 mb-6 border-2 border-gold" style="display: none;">
                    <h4 class="font-semibold text-left mb-3 text-gold flex items-center gap-2">
                        <span class="text-2xl">üéÅ</span> Gift Message
                    </h4>
                    <div id="gift-note" class="text-left text-base italic bg-white/50 p-4 rounded-lg border border-gold/30">
                    </div>
                </div>

                <!-- Items Ordered Section -->
                <div id="order-items-section" class="section-background p-6 mb-6">
                    <h4 class="font-semibold text-left mb-4 text-magenta flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                        </svg>
                        Items Ordered
                    </h4>
                    <div id="order-items-list" class="text-left space-y-3">
                        <!-- Items will be populated here -->
                    </div>
                </div>

                <!-- Order Summary -->
                <div id="order-summary-section" class="section-background p-6 mb-6">
                    <h4 class="font-semibold text-left mb-4 text-magenta">Order Summary</h4>
                    <div class="text-left space-y-2 text-sm">
                        <div class="flex justify-between py-2">
                            <span class="text-gray-600">Subtotal</span>
                            <span id="order-subtotal" class="font-medium">$0.00</span>
                        </div>
                        <div id="discount-row" class="flex justify-between py-2 text-green-600" style="display: none;">
                            <span>Discount</span>
                            <span id="order-discount">-$0.00</span>
                        </div>
                        <div class="flex justify-between py-2">
                            <span class="text-gray-600">Shipping</span>
                            <span id="order-shipping" class="font-medium">$8.90</span>
                        </div>
                        <div class="flex justify-between py-2">
                            <span class="text-gray-600">Tax</span>
                            <span id="order-tax" class="font-medium">$0.00</span>
                        </div>
                        <div class="flex justify-between py-3 border-t border-gray-200 mt-2">
                            <span class="font-bold text-gray-800">Total</span>
                            <span id="order-total-summary" class="font-bold text-magenta text-lg">$0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Download Button -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center items-center mt-6">
                    <button id="download-receipt-btn" 
                            class="cta-gold px-8 py-4 text-lg font-semibold rounded-full shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Download Receipt (PDF)
                    </button>
                </div>
            </div>

            <!-- Next Steps - Will be hidden for invalid/not paid orders -->
            <div id="next-steps" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 max-w-4xl mx-auto" style="display: none;">
                <div class="section-background p-6 hover:shadow-lg transition-all">
                    <div class="text-4xl mb-3">üì¶</div>
                    <h4 class="font-semibold mb-2 text-magenta">Production</h4>
                    <p class="text-sm text-gray-600">Your custom item begins production very soon.</p>
                </div>
                
                <div class="section-background p-6 hover:shadow-lg transition-all">
                    <div class="text-4xl mb-3">üíå</div>
                    <h4 class="font-semibold mb-2 text-magenta">Updates</h4>
                    <p class="text-sm text-gray-600">We'll email you at every step of the journey.</p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center mb-8">
                <a href="https://www.theweer.com/case.html" 
                   class="cta-magenta px-8 py-3 text-lg font-semibold rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                    Create Another
                </a>
                <!-- <a href="https://www.theweer.com/track" 
                   class="cta-gold px-8 py-3 text-lg font-semibold rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                    Track Order
                </a> -->
            </div>

            <!-- Generic Message - Will show for invalid/not paid orders -->
            <div id="generic-message" class="section-background max-w-2xl mx-auto p-6 border border-gold/30" style="display: none;">
                <h3 class="text-xl font-semibold mb-3 text-magenta">Order Status</h3>
                <p class="text-gray-600 mb-2" id="generic-message-text">
                    We're having trouble retrieving your order details.
                </p>
                <p class="text-sm text-gray-500">
                    If you believe this is an error, please contact our support team.
                </p>
            </div>

            <!-- Thank You Message - Will only show for PAID orders -->
            <div id="thank-you-message" class="section-background max-w-2xl mx-auto p-6 border border-gold/30" style="display: none;">
                <h3 class="text-xl font-semibold mb-3 text-magenta">Thank You for Choosing TheWeer.com</h3>
                <p class="text-gray-600 mb-2">
                    Your support helps us continue creating magical, personalized art for our community.
                </p>
                <p class="text-sm italic text-gray-500">
                    "From our studio to your hands ‚Äî may your creation bring daily joy."
                </p>
            </div>
        </main>
    </div>

    <footer class="w-full max-w-960px mt-12 py-8 border-t border-gray-200">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="font-bold text-lg mb-4">Contact</h3>
                    <p class="text-sm text-gray-600">Questions about your order?</p>
                    <a href="mailto:support@theweer.com" class="text-sm text-magenta hover:underline">support@theweer.com</a>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-4">Legal</h3>
                    <div class="space-y-2">
                        <a href="/privacy-policy" class="block text-sm text-gray-600 hover:text-magenta">Privacy Policy</a>
                        <a href="/terms-of-service" class="block text-sm text-gray-600 hover:text-magenta">Terms of Service</a>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-4">GOLDEN GATE BLOOMS LLC</h3>
                    <address class="not-italic text-sm text-gray-600">
                        <p>3400 COTTAGE WAY</p>
                        <p>STE G2</p>
                        <p>SACRAMENTO, CA 95825</p>
                    </address>
                </div>
            </div>
            <div class="border-t border-gray-200 mt-8 pt-6 text-center">
                <p class="text-sm text-gray-500">&copy; 2025 Golden Gate Blooms LLC. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // ============ CONFIGURATION ============
        const COGNITO_CONFIG = {
            clientId: '73lf1h32phkqeb9ahu6tqcl9av',
            domain: 'auth.theweer.com'
        };

        const ORDERS_API_ENDPOINT = 'https://x9a46lous3.execute-api.us-east-1.amazonaws.com/prod/prod';

        // ============ STORAGE KEYS ============
        const STORAGE_KEYS = {
            COGNITO_SESSION: 'cognitoSession'
        };

        // ============ HELPER FUNCTIONS ============
        function getAuthToken() {
            try {
                // Try main app session format first
                const session = localStorage.getItem(STORAGE_KEYS.COGNITO_SESSION);
                if (session) {
                    const sessionData = JSON.parse(session);
                    return sessionData.id_token || null;
                }
                
                // Fallback to Cognito format
                const clientId = COGNITO_CONFIG.clientId;
                const lastAuthUser = localStorage.getItem(`CognitoIdentityServiceProvider.${clientId}.LastAuthUser`);
                if (lastAuthUser) {
                    return localStorage.getItem(`CognitoIdentityServiceProvider.${clientId}.${lastAuthUser}.idToken`);
                }
                return null;
            } catch (error) {
                console.error('Failed to get auth token:', error);
                return null;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                return new Date(dateString).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }

        function formatCurrency(amount) {
            if (amount === undefined || amount === null) return '$0.00';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(amount);
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'bg-red-600' : ''}`;
            toast.innerHTML = `${type === 'success' ? '‚úÖ' : '‚ö†Ô∏è'} ${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============ PDF GENERATION ============
        function generatePDF(order) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const MAGENTA = [230, 0, 126];
            const GOLD = [212, 175, 55];
            const CHARCOAL = [46, 46, 46];
            
            try {
                // Header with logo (if available)
                doc.setFillColor(255, 240, 245);
                doc.rect(0, 0, doc.internal.pageSize.width, 40, 'F');
                
                doc.setDrawColor(...MAGENTA);
                doc.setLineWidth(0.5);
                doc.line(14, 35, doc.internal.pageSize.width - 14, 35);
                
                // Title
                doc.setFontSize(28);
                doc.setTextColor(...MAGENTA);
                doc.setFont('helvetica', 'bold');
                doc.text('TheWeer.com', 105, 25, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setTextColor(...CHARCOAL);
                doc.setFont('helvetica', 'normal');
                doc.text('Order Receipt', 105, 45, { align: 'center' });
                
                // Order Information
                doc.setFillColor(255, 255, 255);
                doc.roundedRect(14, 55, doc.internal.pageSize.width - 28, 40, 3, 3, 'F');
                doc.setDrawColor(...MAGENTA);
                doc.roundedRect(14, 55, doc.internal.pageSize.width - 28, 40, 3, 3, 'S');
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...CHARCOAL);
                doc.text('ORDER DETAILS', 20, 65);
                
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text(`Order ID: ${order.order_id || 'N/A'}`, 20, 75);
                doc.text(`Date: ${formatDate(order.created_at)}`, 20, 82);
                doc.text(`Status: ${order.status || 'Processing'}`, 20, 89);
                
                if (order.user_email) {
                    doc.text(`Email: ${order.user_email}`, doc.internal.pageSize.width - 20, 75, { align: 'right' });
                }
                
                // Two-column address layout
                let yPos = 110;
                
                // Shipping Address
                if (order.shipping_address) {
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...MAGENTA);
                    doc.text('Shipping Address', 14, yPos);
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...CHARCOAL);
                    const ship = order.shipping_address || {};
                    const shipLines = [
                        ship.fullName || '',
                        ship.streetAddress || '',
                        ship.address2 || '',
                        `${ship.city || ''} ${ship.state || ''} ${ship.zipCode || ''}`.trim()
                    ].filter(Boolean);
                    
                    let shipY = yPos + 7;
                    shipLines.forEach(line => {
                        doc.text(line, 14, shipY);
                        shipY += 6;
                    });
                    
                    // Billing Address
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...MAGENTA);
                    doc.text('Billing Address', doc.internal.pageSize.width / 2 + 7, yPos);
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...CHARCOAL);
                    
                    let billY = yPos + 7;
                    
                    // Check if billing is same as shipping
                    if (order.billing_address) {
                        const bill = order.billing_address;
                        const billLines = [
                            bill.fullName || '',
                            bill.streetAddress || '',
                            bill.address2 || '',
                            `${bill.city || ''} ${bill.state || ''} ${bill.zipCode || ''}`.trim()
                        ].filter(Boolean);
                        
                        billLines.forEach(line => {
                            doc.text(line, doc.internal.pageSize.width / 2 + 7, billY);
                            billY += 6;
                        });
                    } else {
                        doc.text('Same as shipping address', doc.internal.pageSize.width / 2 + 7, billY);
                    }
                    
                    yPos = Math.max(shipY, billY) + 10;
                }
                
                // Gift Note
                if (order.gift_wrapping && order.gift_note) {
                    doc.setFillColor(255, 240, 245);
                    doc.roundedRect(14, yPos, doc.internal.pageSize.width - 28, 20, 2, 2, 'F');
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...GOLD);
                    doc.text('üéÅ Gift Message', 20, yPos + 7);
                    
                    doc.setFont('helvetica', 'italic');
                    doc.setTextColor(...CHARCOAL);
                    doc.setFontSize(9);
                    const giftNote = order.gift_note.length > 80 
                        ? order.gift_note.substring(0, 80) + '...' 
                        : order.gift_note;
                    doc.text(`"${giftNote}"`, 20, yPos + 15);
                    
                    yPos += 30;
                } else {
                    yPos += 10;
                }
                
                // Order Items Table
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...MAGENTA);
                doc.setFontSize(11);
                doc.text('Order Summary', 14, yPos);
                
                const tableData = [];
                let subtotal = 0;
                
                // Add items with thumbnails represented as icons
                if (order.items && Array.isArray(order.items)) {
                    order.items.forEach(item => {
                        if (!item.isGiftWrapping) {
                            const price = parseFloat(item.original_price || item.final_price || item.price || 0);
                            subtotal += price;
                            
                            // Determine item name and details
                            const itemName = item.palette_name || item.name || 'Phone Case';
                            const itemDetails = item.device || 'Custom Device';
                            
                            tableData.push([
                                itemName,
                                itemDetails,
                                `$${price.toFixed(2)}`
                            ]);
                        }
                    });
                }
                
                // Add gift wrapping as item
                if (order.gift_wrapping) {
                    subtotal += 30;
                    tableData.push([
                        'Gift Wrapping',
                        'Premium gift wrap',
                        '$30.00'
                    ]);
                }
                
                // Calculate totals
                const discount = parseFloat(order.discount_amount || 0);
                const shipping = parseFloat(order.shipping_cost || 8.90);
                const tax = parseFloat(order.tax_amount || 0);
                const total = parseFloat(order.amount || (subtotal - discount + shipping + tax));
                
                // Generate table
                doc.autoTable({
                    startY: yPos + 8,
                    head: [['Item', 'Details', 'Price']],
                    body: tableData,
                    foot: [
                        ['Subtotal', '', `$${subtotal.toFixed(2)}`],
                        ...(discount > 0 ? [['Discount', '', `-$${discount.toFixed(2)}`]] : []),
                        ['Shipping', '', `$${shipping.toFixed(2)}`],
                        ['Tax', '', `$${tax.toFixed(2)}`],
                        ['Total', '', `$${total.toFixed(2)}`]
                    ],
                    theme: 'plain',
                    headStyles: { 
                        fillColor: MAGENTA,
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        halign: 'left'
                    },
                    footStyles: [
                        { fillColor: [255, 255, 255], textColor: CHARCOAL, fontStyle: 'bold', halign: 'left' },
                        { fillColor: [255, 255, 255], textColor: CHARCOAL, fontStyle: 'bold', halign: 'left' },
                        { fillColor: [255, 255, 255], textColor: CHARCOAL, fontStyle: 'bold', halign: 'right' }
                    ],
                    columnStyles: {
                        0: { cellWidth: 70 },
                        1: { cellWidth: 60 },
                        2: { cellWidth: 30, halign: 'right' }
                    },
                    margin: { left: 14, right: 14 },
                    styles: { fontSize: 9, cellPadding: 3 }
                });
                
                // Thank You Message
                const finalY = doc.lastAutoTable.finalY + 15;
                
                doc.setFillColor(...GOLD);
                doc.roundedRect(14, finalY, doc.internal.pageSize.width - 28, 20, 3, 3, 'F');
                
                doc.setFontSize(11);
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.text('Thank You for Your Order!', 105, finalY + 8, { align: 'center' });
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text('Your custom creation will be processed soon.', 105, finalY + 15, { align: 'center' });
                
                // Footer
                const footerY = doc.internal.pageSize.height - 15;
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text('GOLDEN GATE BLOOMS LLC ‚Ä¢ 3400 COTTAGE WAY, STE G2 ‚Ä¢ SACRAMENTO, CA 95825', 105, footerY, { align: 'center' });
                
                // Save PDF
                doc.save(`TheWeer_Receipt_${order.order_id || 'order'}.pdf`);
                showToast('Receipt downloaded successfully');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                generateSimplePDF(order);
            }
        }

        function generateSimplePDF(order) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(22);
            doc.setTextColor(230, 0, 126);
            doc.text('TheWeer.com', 105, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('Order Receipt', 105, 30, { align: 'center' });
            
            doc.setFontSize(10);
            doc.text(`Order ID: ${order.order_id || 'N/A'}`, 14, 50);
            doc.text(`Date: ${formatDate(order.created_at)}`, 14, 60);
            doc.text(`Email: ${order.user_email || 'N/A'}`, 14, 70);
            doc.text(`Total: ${formatCurrency(order.amount || 0)}`, 14, 80);
            
            doc.save(`TheWeer_Receipt_${order.order_id || 'order'}.pdf`);
            showToast('Receipt downloaded successfully');
        }

        // ============ API FUNCTIONS ============
        async function fetchOrderDetails(orderId) {
            const token = getAuthToken();
            
            console.log(`Fetching order details for: ${orderId}`);
            console.log(`Authentication status: ${token ? 'Authenticated' : 'Guest'}`);
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            try {
                const response = await fetch(ORDERS_API_ENDPOINT, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        action: 'getOrderDetails',
                        order_id: orderId
                    }),
                    mode: 'cors',
                    credentials: 'omit'
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('This order belongs to a different account. Please sign in with the correct email.');
                    }
                    const error = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(error.error || `Failed to fetch order (${response.status})`);
                }

                const data = await response.json();
                return data.order || data;
                
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // ============ UI FUNCTIONS ============
        function displayOrderDetails(order) {
            // Hide loading
            document.getElementById('loading-state').style.display = 'none';
            
            // Check if order is valid and PAID
            const isValidOrder = order && order.order_id;
            const isPaid = order && order.status && order.status.toUpperCase() === 'PAID';
            
            if (!isValidOrder || !isPaid) {
                // Show only generic message - no confirmation elements
                document.getElementById('generic-message').style.display = 'block';
                
                // Update generic message text based on error type
                const genericText = document.getElementById('generic-message-text');
                if (!isValidOrder) {
                    genericText.textContent = 'Invalid order ID. Please check your order number and try again.';
                } else if (!isPaid) {
                    genericText.textContent = `This order is ${order.status || 'not paid'}. Please complete payment to view details.`;
                }
                
                // Hide all confirmation/success elements
                document.getElementById('success-icon').style.display = 'none';
                document.getElementById('success-title').style.display = 'none';
                document.getElementById('success-quote').style.display = 'none';
                document.getElementById('order-details-section').style.display = 'none';
                document.getElementById('next-steps').style.display = 'none';
                document.getElementById('thank-you-message').style.display = 'none';
                
                // Show user email if authenticated
                const token = getAuthToken();
                if (token && order.user_email) {
                    const userEmailDisplay = document.getElementById('user-email-display');
                    userEmailDisplay.textContent = `${order.user_email.split('@')[0]}`;
                    userEmailDisplay.classList.remove('hidden');
                }
                
                return;
            }
            
            // If we get here, order is valid and PAID - show all confirmation elements
            document.getElementById('success-icon').style.display = 'block';
            document.getElementById('success-title').style.display = 'block';
            document.getElementById('success-quote').style.display = 'block';
            document.getElementById('order-details-section').style.display = 'block';
            document.getElementById('next-steps').style.display = 'grid';
            document.getElementById('thank-you-message').style.display = 'block';
            document.getElementById('generic-message').style.display = 'none';
            
            // Show user email in header if authenticated and matches
            const token = getAuthToken();
            if (token && order.user_email) {
                const userEmailDisplay = document.getElementById('user-email-display');
                userEmailDisplay.textContent = `${order.user_email.split('@')[0]}`;
                userEmailDisplay.classList.remove('hidden');
            }
            
            // Populate basic data
            document.getElementById('order-id').textContent = order.order_id || 'N/A';
            document.getElementById('customer-email').textContent = order.user_email || 'N/A';
            document.getElementById('order-total').textContent = formatCurrency(order.amount || 0);
            document.getElementById('order-status').innerHTML = `
                <span class="w-2 h-2 bg-green-600 rounded-full animate-pulse"></span>
                ${order.status || 'Confirmed'}
            `;
            document.getElementById('order-date').textContent = formatDate(order.created_at);
            
            // Show shipping address
            if (order.shipping_address) {
                document.getElementById('shipping-address-section').style.display = 'block';
                const ship = order.shipping_address;
                const addressHtml = `
                    <strong>${ship.fullName || ''}</strong><br>
                    ${ship.streetAddress || ''}${ship.address2 ? '<br>' + ship.address2 : ''}<br>
                    ${ship.city || ''} ${ship.state || ''} ${ship.zipCode || ''}
                `;
                document.getElementById('shipping-address').innerHTML = addressHtml;
            }
            
            // Show billing address
            if (order.billing_address) {
                document.getElementById('billing-address-section').style.display = 'block';
                const bill = order.billing_address;
                
                // Check if billing matches shipping
                const isSameAsShipping = JSON.stringify(order.billing_address) === JSON.stringify(order.shipping_address);
                
                if (isSameAsShipping) {
                    document.getElementById('billing-address').innerHTML = `
                        <strong>${bill.fullName || ''}</strong><br>
                        ${bill.streetAddress || ''}${bill.address2 ? '<br>' + bill.address2 : ''}<br>
                        ${bill.city || ''} ${bill.state || ''} ${bill.zipCode || ''}
                    `;
                    document.getElementById('billing-same-as-shipping').style.display = 'block';
                } else {
                    document.getElementById('billing-address').innerHTML = `
                        <strong>${bill.fullName || ''}</strong><br>
                        ${bill.streetAddress || ''}${bill.address2 ? '<br>' + bill.address2 : ''}<br>
                        ${bill.city || ''} ${bill.state || ''} ${bill.zipCode || ''}
                    `;
                }
            }
            
            // Show gift note
            if (order.gift_wrapping && order.gift_note) {
                document.getElementById('gift-note-section').style.display = 'block';
                document.getElementById('gift-note').innerHTML = `"${order.gift_note}"`;
            }
            
            // Populate order items with thumbnails
            const itemsContainer = document.getElementById('order-items-list');
            if (itemsContainer && order.items && Array.isArray(order.items)) {
                itemsContainer.innerHTML = '';
                
                // Calculate subtotal from items
                let calculatedSubtotal = 0;
                
                order.items.forEach(item => {
                    if (!item.isGiftWrapping) {
                        const price = parseFloat(item.original_price || item.final_price || item.price || 0);
                        calculatedSubtotal += price;
                        
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'order-item flex items-center gap-4';
                        
                        // Use thumbnail if available, otherwise show placeholder
                        const thumbnailUrl = item.image_url || item.thumbnail;
                        
                        itemDiv.innerHTML = `
                            <div class="flex-shrink-0">
                                ${thumbnailUrl && thumbnailUrl.startsWith('http') 
                                    ? `<img src="${thumbnailUrl}" alt="${item.palette_name || 'Product'}" class="product-thumbnail">`
                                    : `<div class="product-thumbnail bg-gradient-to-br from-pink-200 to-purple-200 flex items-center justify-center text-2xl">
                                        üå∏
                                       </div>`
                                }
                            </div>
                            <div class="flex-grow">
                                <p class="font-medium">${item.palette_name || item.name || 'Phone Case'}</p>
                                <p class="text-xs text-gray-500">${item.device || 'Custom Device'}</p>
                                ${item.product_type ? `<p class="text-xs text-gray-400">${item.product_type}</p>` : ''}
                            </div>
                            <span class="font-semibold">${formatCurrency(price)}</span>
                        `;
                        itemsContainer.appendChild(itemDiv);
                    }
                });
                
                // Add gift wrapping as item
                if (order.gift_wrapping) {
                    calculatedSubtotal += 30;
                    const giftDiv = document.createElement('div');
                    giftDiv.className = 'order-item flex items-center gap-4';
                    giftDiv.innerHTML = `
                        <div class="flex-shrink-0">
                            <div class="gift-icon">üéÅ</div>
                        </div>
                        <div class="flex-grow">
                            <p class="font-medium">Gift Wrapping</p>
                            <p class="text-xs text-gray-500">Premium gift wrap</p>
                        </div>
                        <span class="font-semibold">$30.00</span>
                    `;
                    itemsContainer.appendChild(giftDiv);
                }
                
                // Update subtotal display with calculated value
                document.getElementById('order-subtotal').textContent = formatCurrency(calculatedSubtotal);
            }
            
            // Get discount
            const discount = parseFloat(order.discount_amount || 0);
            const shipping = parseFloat(order.shipping_cost || 8.90);
            const tax = parseFloat(order.tax_amount || 0);
            const total = parseFloat(order.amount || 0);
            
            // Update summary with stored values
            if (discount > 0) {
                document.getElementById('discount-row').style.display = 'flex';
                document.getElementById('order-discount').textContent = `-${formatCurrency(discount)}`;
            }
            
            document.getElementById('order-shipping').textContent = formatCurrency(shipping);
            document.getElementById('order-tax').textContent = formatCurrency(tax);
            document.getElementById('order-total-summary').textContent = formatCurrency(total);
            
            // Setup PDF download button
            const downloadBtn = document.getElementById('download-receipt-btn');
            if (downloadBtn) {
                downloadBtn.onclick = () => generatePDF(order);
            }
        }

        function displayError(message) {
            document.getElementById('loading-state').style.display = 'none';
            
            // Hide all confirmation elements
            document.getElementById('success-icon').style.display = 'none';
            document.getElementById('success-title').style.display = 'none';
            document.getElementById('success-quote').style.display = 'none';
            document.getElementById('order-details-section').style.display = 'none';
            document.getElementById('next-steps').style.display = 'none';
            document.getElementById('thank-you-message').style.display = 'none';
            
            // Show generic message with error
            const genericDiv = document.getElementById('generic-message');
            genericDiv.style.display = 'block';
            
            const genericText = document.getElementById('generic-message-text');
            genericText.textContent = message;
            
            const isAuthError = message.toLowerCase().includes('unauthorized') || 
                               message.toLowerCase().includes('different account') ||
                               message.toLowerCase().includes('sign in');
            
            if (isAuthError) {
                const contactHtml = `
                    <div class="mt-3 flex gap-3 justify-center">
                        <button onclick="window.location.reload()" 
                                class="text-sm px-4 py-2 bg-magenta text-white rounded-full hover:bg-opacity-90">
                            Try Again
                        </button>
                    </div>
                `;
                genericDiv.innerHTML += contactHtml;
            }
        }

        // ============ CONFETTI ============
        function createConfetti() {
            const colors = ['#E6007E', '#D4AF37', '#FFD0E6', '#2E2E2E'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    confetti.style.width = Math.random() * 10 + 5 + 'px';
                    confetti.style.height = confetti.style.width;
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 20);
            }
        }

        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Order status page initializing...');
            
            createConfetti();
            
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('order_id');
            
            if (!orderId) {
                console.warn('No order_id found in URL');
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('generic-message').style.display = 'block';
                document.getElementById('generic-message-text').textContent = 'No order ID provided. Please check your order confirmation email for a valid link.';
                return;
            }
            
            console.log(`üîç Loading order details for: ${orderId}`);
            
            try {
                const order = await fetchOrderDetails(orderId);
                displayOrderDetails(order);
                console.log('‚úÖ Order details loaded successfully');
            } catch (error) {
                console.error('‚ùå Failed to load order:', error);
                displayError(error.message);
            }
        });

        window.addEventListener('error', function(e) {
            console.error('üí• Page error:', e.error || e.message);
        });
    </script>
</body>
</html>
