<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bloom - Order Confirmed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="bloom-app/config.js"></script>
    <script src="bloom-app/auth-manager.js"></script>
    <style>
        /* --- Dreamlike Elegance Theme --- */
        :root {
            --color-magenta: #E6007E;
            --color-gold: #D4AF37;
            --color-charcoal: #2E2E2E;
            --color-blush-start: #FFD0E6;
            --color-blush-end: #FFF7FB;
            --color-gray-300: #d1d5db;
            --color-gray-600: #4b5563;
        }
        
        .bg-magenta { background-color: var(--color-magenta); }
        .bg-gold { background-color: var(--color-gold); }
        .bg-gray-300 { background-color: var(--color-gray-300); }
        .text-white { color: white; }
        .text-gray-600 { color: var(--color-gray-600); }
        .border-magenta { border-color: var(--color-magenta); }
        .border-gold { border-color: var(--color-gold); }
        .border-gray-300 { border-color: var(--color-gray-300); }
        .text-magenta { color: var(--color-magenta); }
        .text-gold { color: var(--color-gold); }
        .font-semibold { font-weight: 600; }

        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=Manrope:wght@400;600&display=swap');
        
        body {
            font-family: 'Manrope', sans-serif;
            background-color: var(--color-blush-end);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: var(--color-charcoal);
        }
        .container {
            width: 100%;
            max-width: 960px;
            background: white;
            padding: 32px;
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }
        .header {
            border-bottom: 1px solid var(--color-blush-start);
        }
        h1, h2, h3, .poetic-title {
            font-family: 'Cormorant Garamond', serif;
            letter-spacing: 0.05em;
        }
        .poetic-title {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--color-charcoal);
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .cta-magenta {
            background-color: var(--color-magenta);
            color: white;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .cta-magenta:hover {
            background-color: #C00063; 
            box-shadow: 0 4px 10px rgba(230, 0, 126, 0.4);
        }
        .cta-gold {
            background-color: var(--color-gold);
            color: var(--color-charcoal);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .cta-gold:hover {
            background-color: #C09A34;
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.4);
        }
        .section-background {
            background: linear-gradient(135deg, var(--color-blush-start) 0%, var(--color-blush-end) 100%);
            padding: 20px;
            border-radius: 12px;
        }
        .gold-highlight {
            color: var(--color-gold);
            font-weight: 600;
        }
        .success-animation {
            animation: bloom 1s ease-out;
        }
        @keyframes bloom {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--color-magenta);
            opacity: 0;
            animation: confetti-fall 3s ease-in-out forwards;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        .error-message {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #b91c1c;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Core Config and Auth -->
    <script src="bloom-app/config.js"></script>
    <script src="bloom-app/auth-manager.js"></script>
</head>
<body>
    <div class="container">
        <header class="header flex justify-between items-center pb-4 mb-6">
            <img src="logo.png" alt="Bloom" class="h-12 w-auto">
        </header>

        <main class="text-center">
            <!-- Success Icon -->
            <div class="success-animation mb-8">
                <div class="w-32 h-32 bg-green-100 rounded-full flex items-center justify-center mx-auto border-4 border-green-200">
                    <svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
            </div>

            <!-- Main Success Message -->
            <h1 class="poetic-title text-4xl mb-6">Your Bloom is Complete</h1>
            
            <div class="text-center italic mb-8">
                <p class="text-xl text-gray-600 mb-4">"Your reflection has blossomed into art."</p>
            </div>

            <!-- Order Details Section (Populated by JavaScript) -->
            <div id="order-details-section" class="section-background max-w-2xl mx-auto mb-8" style="display: none;">
                <h3 class="text-2xl font-semibold mb-4">Order Confirmation</h3>
                <div class="text-left space-y-3 mb-6">
                    <div class="flex justify-between">
                        <span class="font-semibold">Order ID:</span>
                        <span id="order-id" class="gold-highlight">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-semibold">Email:</span>
                        <span id="customer-email">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-semibold">Total:</span>
                        <span id="order-total" class="gold-highlight">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-semibold">Status:</span>
                        <span id="order-status" class="text-green-600 font-semibold">Payment Confirmed</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="font-semibold">Date:</span>
                        <span id="order-date">Loading...</span>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-4">
                    <p class="text-sm text-gray-600 mb-2">‚ú® A confirmation email has been sent to your inbox.</p>
                    <p class="text-sm text-gray-600">üìé Your receipt is available for download below.</p>
                </div>
            </div>

            <!-- Next Steps -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 max-w-4xl mx-auto">
                <div class="section-background p-6">
                    <div class="text-3xl mb-3">üì¶</div>
                    <h4 class="font-semibold mb-2">Production</h4>
                    <p class="text-sm text-gray-600">Your custom bloom begins production very soon.</p>
                </div>
                
                <div class="section-background p-6">
                    <div class="text-3xl mb-3">üíå</div>
                    <h4 class="font-semibold mb-2">Updates</h4>
                    <p class="text-sm text-gray-600">We'll email you at every step of the journey.</p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div id="action-buttons" class="flex flex-col sm:flex-row gap-4 justify-center mb-8">
                <button onclick="window.location.href='https://www.theweer.com/case.html'" 
                        class="cta-magenta px-8 py-3 text-lg font-semibold rounded-full shadow-lg hover:shadow-xl">
                    Create Another Bloom
                </button>
                
                <!-- Download Receipt button will be dynamically added here -->
            </div>

            <!-- Thank You Message -->
            <div class="section-background max-w-2xl mx-auto">
                <h3 class="text-xl font-semibold mb-3">Thank You for Choosing TheWeer.com</h3>
                <p class="text-gray-600 mb-2">
                    Your support helps us continue creating magical, personalized art for our community.
                </p>
                <p class="text-sm italic text-gray-500">
                    "From our studio to your hands ‚Äî may your bloom bring daily joy."
                </p>
            </div>
        </main>
    </div>

    <footer class="w-full max-w-960px mt-12 py-8 border-t border-gray-200">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Contact -->
                <div>
                    <h3 class="font-bold text-lg mb-4">Contact</h3>
                    <p class="text-sm text-gray-600">Questions about your order?</p>
                    <a href="mailto:bloom@theweer.com" class="text-sm text-magenta hover:underline">bloom@theweer.com</a>
                </div>

                <!-- Legal Links -->
                <div>
                    <h3 class="font-bold text-lg mb-4">Legal</h3>
                    <div class="space-y-2">
                        <a href="/privacy-policy" class="block text-sm text-gray-600 hover:text-magenta transition-colors">Privacy Policy</a>
                        <a href="/terms-of-service" class="block text-sm text-gray-600 hover:text-magenta transition-colors">Terms of Service</a>
                    </div>
                </div>
                
                <!-- Company Info -->
                <div>
                    <h3 class="font-bold text-lg mb-4">GOLDEN GATE BLOOMS LLC</h3>
                    <address class="not-italic text-sm text-gray-600">
                        <p>3400 COTTAGE WAY</p>
                        <p>STE G2</p>
                        <p>SACRAMENTO, CA 95825</p>
                    </address>
                </div>
            </div>
            
            <div class="border-t border-gray-200 mt-8 pt-6 text-center">
                <p class="text-sm text-gray-500">&copy; 2025 Golden Gate Blooms LLC. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // --- Confetti Animation ---
        function createConfetti() {
            console.log('üéä Launching confetti celebration!');
            const colors = ['#E6007E', '#D4AF37', '#FFD0E6', '#2E2E2E'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 3000);
            }
        }

        // --- Order Manager Class (Handles all order-related API calls) ---
        class OrderManager {
            constructor() {
                this.apiEndpoint = CONFIG?.ORDERS_API_ENDPOINT || 'https://x9a46lous3.execute-api.us-east-1.amazonaws.com/prod/prod';
            }

            async getAuthToken() {
                // Try multiple ways to get the token, just like the main app
                try {
                    // Method 1: Check if we're in the main app context
                    if (window.app && window.app.authManager) {
                        const session = window.app.authManager.getSession();
                        return session?.id_token || null;
                    }
                    
                    // Method 2: Check for global getSession (from app.js)
                    if (typeof window.getSession === 'function') {
                        const session = window.getSession();
                        return session?.id_token || null;
                    }
                    
                    // Method 3: Check localStorage directly (Cognito typically stores tokens here)
                    const cognitoUser = JSON.parse(localStorage.getItem(`CognitoIdentityServiceProvider.${CONFIG.COGNITO.CLIENT_ID}.LastAuthUser`) || 'null');
                    if (cognitoUser) {
                        const idToken = localStorage.getItem(`CognitoIdentityServiceProvider.${CONFIG.COGNITO.CLIENT_ID}.${cognitoUser}.idToken`);
                        if (idToken) return idToken;
                    }
                    
                    return null;
                } catch (error) {
                    console.error('Failed to get auth token:', error);
                    return null;
                }
            }

            async fetchOrderDetails(orderId) {
                const token = await this.getAuthToken();
                if (!token) {
                    throw new Error('Please sign in to view your order details');
                }

                const response = await fetch(this.apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        action: 'getOrderDetails',
                        order_id: orderId
                    })
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(error.error || `Failed to fetch order (${response.status})`);
                }

                const data = await response.json();
                return data.order;
            }

            // --- FUTURE METHODS PLACEHOLDER ---
            // async trackShipment(orderId) { ... }
            // async requestReturn(orderId) { ... }
            // async getOrderHistory() { ... }
            // ---------------------------------

            formatDate(dateString) {
                if (!dateString) return 'N/A';
                return new Date(dateString).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            generatePDF(order) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(24);
                doc.setTextColor(230, 0, 126);
                doc.text('BLOOM', 105, 20, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text('Order Confirmation', 105, 30, { align: 'center' });
                
                // Order Info
                doc.setFontSize(10);
                doc.text(`Order ID: ${order.order_id || 'N/A'}`, 14, 45);
                doc.text(`Date: ${this.formatDate(order.created_at)}`, 14, 52);
                doc.text(`Status: ${order.status || 'Confirmed'}`, 14, 59);
                
                // Customer Info
                doc.setFontSize(12);
                doc.setTextColor(230, 0, 126);
                doc.text('Customer Information', 14, 75);
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Email: ${order.user_email || 'N/A'}`, 14, 85);
                
                // Shipping Address
                doc.setFontSize(12);
                doc.setTextColor(230, 0, 126);
                doc.text('Shipping Address', 14, 105);
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                const ship = order.shipping_address || {};
                const addressLines = [
                    ship.fullName || '',
                    ship.streetAddress || '',
                    ship.address2 || '',
                    `${ship.city || ''} ${ship.state || ''} ${ship.zipCode || ''}`.trim()
                ].filter(Boolean);
                
                let yPos = 115;
                addressLines.forEach(line => {
                    doc.text(line, 14, yPos);
                    yPos += 7;
                });
                
                // Order Summary Table
                doc.setFontSize(12);
                doc.setTextColor(230, 0, 126);
                doc.text('Order Summary', 14, yPos + 15);
                
                const tableData = [
                    ['Subtotal', `$${(order.subtotal || 0).toFixed(2)}`],
                    ['Discount', `-$${(order.discount_amount || 0).toFixed(2)}`],
                    ['Shipping', `$${(order.shipping_cost || 8.90).toFixed(2)}`],
                    ['Tax', `$${(order.tax_amount || 0).toFixed(2)}`]
                ];
                
                doc.autoTable({
                    startY: yPos + 25,
                    head: [['Description', 'Amount']],
                    body: tableData,
                    theme: 'striped',
                    headStyles: { fillColor: [230, 0, 126] },
                    foot: [['Total', `$${(order.amount || 0).toFixed(2)}`]],
                    footStyles: { fillColor: [212, 175, 55], textColor: [0, 0, 0], fontStyle: 'bold' }
                });
                
                // Footer
                const finalY = doc.lastAutoTable.finalY + 20;
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                doc.text('Thank you for choosing Golden Gate Blooms LLC', 105, finalY, { align: 'center' });
                doc.text('3400 COTTAGE WAY, STE G2, SACRAMENTO, CA 95825', 105, finalY + 7, { align: 'center' });
                
                // Save PDF
                doc.save(`Bloom_Order_${order.order_id || 'receipt'}.pdf`);
            }

            displayOrderDetails(order) {
                // Update DOM elements
                document.getElementById('order-id').textContent = order.order_id || 'N/A';
                document.getElementById('customer-email').textContent = order.user_email || 'N/A';
                document.getElementById('order-total').textContent = `$${(order.amount || 0).toFixed(2)}`;
                document.getElementById('order-status').textContent = order.status || 'Confirmed';
                document.getElementById('order-date').textContent = this.formatDate(order.created_at);
                
                // Show the order details section
                document.getElementById('order-details-section').style.display = 'block';
                
                // Add Download Receipt button if not already present
                if (!document.getElementById('download-receipt-btn')) {
                    const buttonContainer = document.getElementById('action-buttons');
                    const receiptBtn = document.createElement('button');
                    receiptBtn.id = 'download-receipt-btn';
                    receiptBtn.className = 'cta-gold px-8 py-3 text-lg font-semibold rounded-full shadow-lg hover:shadow-xl';
                    receiptBtn.innerHTML = 'üìÑ Download Receipt';
                    receiptBtn.onclick = () => this.generatePDF(order);
                    buttonContainer.appendChild(receiptBtn);
                }
            }

            displayError(message) {
                const mainElement = document.querySelector('main');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-xl">‚ö†Ô∏è</span>
                        <div class="text-left">
                            <p class="font-bold">Unable to load order details</p>
                            <p class="text-sm mt-1">${message}</p>
                            <p class="text-sm mt-2">Please check your email for confirmation or contact support at <a href="mailto:bloom@theweer.com" class="underline">bloom@theweer.com</a></p>
                        </div>
                    </div>
                `;
                
                // Insert at the top of main content
                const firstChild = mainElement.firstChild;
                mainElement.insertBefore(errorDiv, firstChild);
            }
        }

        // --- Page Initialization ---
        document.addEventListener('DOMContentLoaded', async function() {
            // Start confetti celebration
            createConfetti();
            
            // Get order_id from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('order_id');
            
            if (!orderId) {
                console.warn('No order_id found in URL - displaying generic success page');
                return;
            }
            
            console.log(`üîç Loading order details for: ${orderId}`);
            
            try {
                const orderManager = new OrderManager();
                const order = await orderManager.fetchOrderDetails(orderId);
                orderManager.displayOrderDetails(order);
                console.log('‚úÖ Order details loaded successfully');
            } catch (error) {
                console.error('‚ùå Failed to load order:', error);
                const orderManager = new OrderManager();
                orderManager.displayError(error.message);
            }
        });

        // Global error logging
        window.addEventListener('error', function(e) {
            console.error('üí• Page error:', e.error || e.message);
        });
    </script>
</body>
</html>
